function save(){var a=null,b=null;order=new Array;var c=0,d=new Object,e=new Object,f=new Object,g=0,h=0;$("div.imageplaceholder").each(function(){a=$(this).find(".cropbox"),a.hasClass("blackAndWhite")?g=1:g=0;if(a.hasClass("rotate")){var b=$(this).find("img").attr("src");h=b.split("/").pop()}else h=0;var d="",f="";d=toptext,toptextfont=$("#text-font").val(),f=$("#text-color").val(),order[c]=new Array,e["image"+c]={sorting:c,imagefield_width:$(this).width(),imagefield_height:$(this).height(),width:a.width(),height:a.height(),"margin-left":a.css("left"),"margin-top":a.css("top"),imageid:a.attr("imageid"),blackandwhite:g,rotate:h,toptext:d,toptextfont:toptextfont,toptextcolor:f},c++}),c=0,$(".imagetext").each(function(){f["name"+c]={sorting:c,width:$(this).width(),height:$(this).height(),font:$("#text-font").val(),color:$("#text-color").val(),text:$(this).attr("alt")},c++}),d.template={prodno:malArray.prodno,malid:malArray.mal_id,mal_width:malArray.mal_width,mal_height:malArray.mal_height,imagefield_height:malArray.imagefield_height,imagefield_width:malArray.imagefield_width,imagefield_x:malArray.imagefield_x,imagefield_y:malArray.imagefield_y,imagefield_space:malArray.imagefield_space,editorcontainer_width:editorcontainer_width,ratio:ratio,gridcolor:$("#color").val(),numberofcolumns:numberofcolumns,background:$("#background").val(),clipart:$("input[name=clipart]:checked").val(),maskit:$("input[name=maskit]:checked").val(),imagelayout:imagelayout,margin:margin},d.grid={color:$("#color").val(),quantity:numberofdays,gridvalues:gridarray},d.weekdays={font:"Century_Gothic",color:$("#day-color").val(),background:$("#day-color-background").val()},d.product={productid:$("#productid").val(),productoptionid:$("#productoptionid").val(),quantity:$("#quantity").val()},d.images=e,d.names=f;if(portal=="UP-DK")var i="/kurv/ugeplan/accessories";else var i="/cart/ukeplan/accessories/";return $.ajax({type:"post",cache:!1,url:"/api/1.0/editor/ukeplan",data:d,success:function(a){return document.location.href=i,!1},complete:function(a){return!1},error:function(a){alert("error")}}),!1}function parseIntUkeplan(a){var b=Math.round(a*Math.pow(10,0))/Math.pow(10,0);return b}function setupgrid(){$(".textplaceholder").append('<table class="texttable"></table>'),$(gridarray).each(function(a,b){$(".textplaceholder table").append('<tr><td><img class="day" alt="'+b+'" src="" /></td></tr>')})}function setupText(){var a=$("#day-color").val().replace("#",""),b=parseIntUkeplan($(".grid").height()/numberofdays)-2,c=parseIntUkeplan(margin/ratio)-2;$("img.day").each(function(){$(this).attr("src","/api/1.0/gift/text_ukeplan/?id=0&quality=1&png=1&font=arial&gravity=West&color="+a+"&background="+encodeURIComponent(backgroundcolor)+"&text="+$(this).attr("alt")+"&width="+b+"&height="+c+"&rotate="+rotate)})}function updateTopText(a){a=encodeURIComponent(a);var b=textheight/ratio,c=(malArray.mal_width-malArray.imagefield_width-margin*2)/ratio,d=encodeURIComponent($("#text-color").val()),e=encodeURIComponent(backgroundcolor),f=$("#text-font").val(),g="/api/1.0/gift/toptext?text="+a+"&width="+c+"&height="+b+"&color="+d+"&background="+e+"&font="+f+"&bottom_margin=0";$(".toptext").html('<img id="toptext" class="cropbox" src="'+g+'" imageid="textimage" />'),$(".toptextplaceholder").css({position:"absolute",left:margin/ratio+"px",top:margin/ratio+"px",width:c+"px","text-align":"center"})}function setupTemplateColor(){var a=$("#color").val();imagelayout=="text"?$(".imageplaceholder").css({"border-color":backgroundcolor}):$(".imageplaceholder").css({"border-color":a}),$(".grid").css({"border-color":a}),$("table.grid td").css({"border-color":a})}function setupTemplate(){var a=malArray.imagefield_space/ratio;$(".editorcontainer").css({height:malArray.mal_height/ratio+"px",width:malArray.mal_width/ratio+"px"}),$(".imageplaceholder").css({height:parseIntUkeplan(malArray.imagefield_height/ratio)+"px",width:parseIntUkeplan(malArray.imagefield_width/ratio)+"px"}),$(".grid").css({height:gridheight+"px"}).height(gridheight),$(".gridplaceholder").css({left:margin/ratio+"px",top:(margin+textheight)/ratio+3+"px",width:(margin+malArray.imagefield_width)/ratio+"px"}),$(".texttable").attr("height",gridheight),$("div.textplaceholder").css({top:(margin+textheight)/ratio+3+"px",height:gridheight+"px"}),$(".rightcolumn").css({width:parseIntUkeplan(malArray.imagefield_width/ratio)+"px",top:parseIntUkeplan(malArray.imagefield_y/ratio)+"px",left:parseIntUkeplan(malArray.imagefield_x/ratio)+"px",position:"relative"});var b=parseIntUkeplan((malArray.mal_height-malArray.imagefield_height-textheight-margin-margin)/ratio/3);$(".husk").css({height:b*2+"px"}),$(".dagenidag, .Dato").css({height:b/2+"px"}),$("#notatoption").prop("checked")&&$(".notatfelt").css({height:1e3/ratio,width:notatwidth+"px",left:margin/ratio+2+"px",top:(margin+malArray.imagefield_height)/ratio+gridheight+5+"px"}),$("table.grid").css("margin-left","2px"),updateTopText(toptext)}function loginUser(){var a=$('input[name="username"]').val(),b=$('input[name="password"]').val();$.post("/api/1.0/user/login/",{username:a,password:b},function(a){a.message=="OK"?(imagePickerLoaded=!1,$(".logininfo span:first-child").text(a.result.email),$(".logininfo span:last-child").html('<a href="/logout">Logg ut</a>'),$(".loginbox").remove(),$(".getimagebox").show(),imagePicker(),$("#loginbox").remove()):$("#loginbox").append('<span class="label label-warning">'+a.message+"</span>")},"json")}function imagePicker(){imagePickerLoaded||$.post("/api/1.0/albums/enum_new",{},function(a){a.result&&(imagePickerLoaded=!0,$("#imagePicker .loader").remove(),$(a.albums).each(function(a,b){$("#imagePicker ul.albums").append($("<li/>").append($("<a/>",{href:"#",text:b.title,title:b.title,click:function(){$("#imagePicker ul.albums li a.selected").removeClass("selected"),$(this).addClass("selected"),loadAlbum($(this),b,"#imagePickerImages")}}))),a==0&&($(this).addClass("selected"),loadAlbum($(this),b,"#imagePickerImages"))})),imagePickerLoaded=!0},"json")}function checkquality(a,b){var c=$(a.currentTarget).attr("imageid"),d=originalimage[c],e=malArray.imagefield_height/ratio,f=$(a.currentTarget).height()*ratio/118,g=d.y/f*2.5432;g>=150?$(a.currentTarget).parent().find(".quality").attr("src",staticsite+"gfx/ukeplan/new/top.png"):g<150&&g>=50?$(a.currentTarget).parent().find(".quality").attr("src",staticsite+"gfx/ukeplan/new/avg.png"):g<50&&$(a.currentTarget).parent().find(".quality").attr("src",staticsite+"gfx/ukeplan/new/bad.png")}function pickImage(a){var b=new Image;originalimage[a.id]=a,$(b).load(function(){$("#"+selectedcropbox).attr("imageid")=="noimage"&&$("#"+selectedcropbox).parent().html('<img id="'+selectedcropbox+'" class="cropbox" imageid="" src=""/>');var c=$(".imageplaceholder").width(),d=$(".imageplaceholder").height();$("#"+selectedcropbox).attr("src",a.screensize).attr("imageid",a.id),$("#"+selectedcropbox).cropbox({width:c,height:d}).on("cropbox",checkquality),currentImage=a,previewHeight=b.height,previewWidth=b.width,previewHeight>previewWidth?$("#portrait").click():$("#landscape").click(),$("#"+selectedcropbox).removeClass("blackAndWhite"),$("#"+selectedcropbox).parent().append('<img class="quality" src="" data-toggle="modal" data-target=".qualitytip"/>'),$("#cropbutton").removeAttr("disabled")}),b.src=a.screensize,$("#add-to-cart").removeClass("disabled"),$(".startup").hide(),$("#imageselect").modal("hide")}function loadAlbum(a,b,c){var d=!1;return $.post("/api/1.0/albums/images/enum",{albumid:b.id},function(a){$(c).empty(),$(a.images).each(function(a,b){$(c).append($("<li/>").append($("<a/>",{href:"#",click:function(){return pickImage(b),!1}}).append('<img src="'+b.thumbnail+'" />')))})},"json"),d}var notatwidth;$(document).ready(function(){setupgrid(),setupTemplate(),setupText(),$("#notatoption").on("change",function(){$(this).prop("checked")?(notatheight=1e3,notatwidth=($(".grid").width()+2)*$(".grid").size()-4,$(".editorcontainer").append('<div class="notatfelt"><div class="notat">Notat:</div></div>')):(notatheight=0,$(".notatfelt").remove()),gridheight=(malArray.mal_height-textheight-margin-bottommargin-notatheight)/ratio,setupTemplate(),setupText()}),$(document).on("mouseover",".imageplaceholder",function(){$(".cropControls").css({opacity:"0",filter:"alpha(opacity=0) }"}),$(this).find(".quality").show(),$(this).find(".cropControls").css({opacity:".95",filter:"alpha(opacity=95) }"})}),$(".editorcontainer").mouseleave(function(){$(".cropControls").css({opacity:"0",filter:"alpha(opacity=0) }"}),$(".quality").hide()}),$("#oriantationmodal .cancel").on("click",function(a){$("#oriantationmodal").modal("hide"),$('select[name="orientation"]').val($(".selectedoption").val())}),$("#oriantationmodal .ok").on("click",function(a){$("#oriantationmodal").modal("hide"),window.location.href=$('select[name="orientation"]').val()}),$('select[name="orientation"]').on("change",function(){$("#oriantationmodal").modal({backdrop:"static",keyboard:!0,show:!0})}),$("#loginbutton").on("click",function(){}),$("#loginform").submit(function(a){return a.preventDefault(),loginUser(),!1}),$("#fileupload").fileupload({dataType:"json",done:function(a,b){$.each(b.result.files,function(a,b){var c=$("<img/>").addClass("uploadedthumb").attr({src:b.thumbnail,id:b.id});$("<span/>").append(c).appendTo("#files"),$("#previewimage").attr("src",b.screensize),pickImage(b)}),$("#progress .progress-bar").css("width","0%")},progressall:function(a,b){var c=parseInt(b.loaded/b.total*100,10);$("#progress .progress-bar").css("width",c+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?undefined:"disabled"),$(document).on("click","img.uploadedthumb",function(){var a=$(this).attr("id");pickImage(originalimage[a])}),$("select#color option:selected").each(function(){$("#color").css("background-color",$(this).css("background-color")),$("#color").css("color",$(this).css("color"))}),$("select#text-color option:selected").each(function(){$("#text-color").css("background-color",$(this).css("background-color")),$("#text-color").css("color",$(this).css("color"))}),$("select#day-color option:selected").each(function(){$("#day-color").css("background-color",$(this).css("background-color")),$("#day-color").css("color",$(this).css("color"))}),$.post("/api/1.0/prices/get",{productoptionid:2870,quantity:1},function(a){$("#maskit-price").text(a.price)},"json"),$(document).on("click",".bw",function(){var a=$(this).parent().parent().find(".cropbox");fullDomain=window.location.host,brokenstring=a.attr("src").split("/");var b=0;$(this).attr("id")=="bw"?($(this).attr("id","color").text("Farger"),b=1,$(a).addClass("blackAndWhite")):$(this).attr("id")=="color"&&($(this).attr("id","bw").text("Sort/hvit"),$(a).removeClass("blackAndWhite")),brokenstring[10]||(brokenstring[10]=0);var c="http://"+fullDomain+"/"+brokenstring[3]+"/"+brokenstring[4]+"/"+brokenstring[5]+"/"+brokenstring[6]+"/"+brokenstring[7]+"/"+brokenstring[8]+"/"+b+"/"+brokenstring[10];a.attr("src",c)}),$("#clipart").click(function(){return $("#"+selectedcropbox).attr({src:middagsbestikk,height:malArray.imagefield_height/ratio+"px",imageid:"dinner"}).css({height:malArray.imagefield_height/ratio+"px",top:"",left:"","margin-left":"","margin-top":"",width:""}),$("#"+selectedcropbox).parent().addClass("dinner"),$("#imageselect").modal("hide"),!1}),$("#color").change(function(){return $("select#color option:selected").each(function(){$("#color").css("background-color",$(this).css("background-color")),$("#color").css("color",$(this).css("color"))}),setupTemplateColor(),setupText(),!1}),$("#day-color").change(function(){return $("select#day-color option:selected").each(function(){$("#day-color").css("background-color",$(this).css("background-color")),$("#day-color").css("color",$(this).css("color"))}),setupText(),!1}),$("#text-color").change(function(){return $("select#text-color option:selected").each(function(){$("#text-color").css("background-color",$(this).css("background-color")),$("#text-color").css("color",$(this).css("color"))}),updateTopText(toptext),!1}),$("#text-font").change(function(){return updateTopText(toptext),!1}),$(".imageplaceholder").html('<div id="cropbox1" class="btn btn-default cropbox" style="position: relative; color: #fff" height="150"  imageid="noimage" >'+chooseimagestring+"</div>"),$(document).on("click",".openimagebox",function(){selectedcropbox=$(this).parent().parent().find(".cropbox").attr("id"),$("#imageselect").modal()}),$(document).on("click",".cropbox",function(){if($(this).attr("imageid")=="textimage"){var a=decodeURIComponent(toptext);a=$.trim(a),a=="Legg til tekst"&&(a="");var b=$(".toptextplaceholder").width();$(this).parent().parent().append('<div class="center edittoptext" " style="width: '+b+'px">Sett inn ny tekst<br/><input type="text" id="toptextedit" style="width:300px; text-align:center;" value="'+a+'" placeholder="'+a+'"/>'+'<br/><button id="toptext-confirm">Oppdater</button></div>'),$("#toptextedit").focus()}else $(this).attr("imageid")=="noimage"&&(selectedcropbox=$(this).attr("id"),$("#imageselect").modal())}),$(document).on("keypress","input[name=inputtext]",function(a){a.keyCode==13&&updateName($(this))}),$(document).on("click","#submittext",function(){return updateName($(this)),!1}),$("a#openLoginDialog").click(function(){return loginDialog(),!1}),$(".container").on("hover",".imageandtextplaceholder",function(a){$(".imageplaceholder").css("cursor","pointer")}),$(document).on("click","#getimagebutton",function(){imagePicker()}),$(document).on("submit","#order_ukeplan",function(){return $(".confirmtip").modal(),!1}),$("#confirmproject").on("click",save),$(document).on("click",".rotateRight",function(){var a=$(this).parent().parent().find(".cropbox");fullDomain=window.location.host,brokenstring=a.attr("src").split("/"),brokenstring[10]||(brokenstring[10]=0),brokenstring[9]||(brokenstring[9]=0);var b=parseInt(brokenstring[10])+90;if(b==-90||b==-270)b=360+b;if(b==360||b==-360)b=0;var c="http://"+fullDomain+"/"+brokenstring[3]+"/"+brokenstring[4]+"/"+brokenstring[5]+"/"+brokenstring[6]+"/"+brokenstring[7]+"/"+brokenstring[8]+"/"+brokenstring[9]+"/"+b,d=$(".imageplaceholder").height(),e=$(".imageplaceholder").width();a.attr("src",c),b>0?a.addClass("rotate"):a.removeClass("rotate"),a.cropbox({width:e,height:d})}),$(document).on("click",".rotateLeft",function(){var a=$(this).parent().parent().find(".cropbox");fullDomain=window.location.host,brokenstring=a.attr("src").split("/"),brokenstring[10]||(brokenstring[10]=0),brokenstring[9]||(brokenstring[9]=0);var b=parseInt(brokenstring[10])-90;if(b==-90||b==-270)b=360+b;if(b==360||b==-360)b=0;var c="http://"+fullDomain+"/"+brokenstring[3]+"/"+brokenstring[4]+"/"+brokenstring[5]+"/"+brokenstring[6]+"/"+brokenstring[7]+"/"+brokenstring[8]+"/"+brokenstring[9]+"/"+b,d=$(".imageplaceholder").height(),e=$(".imageplaceholder").width();a.attr("src",c),b>0?a.addClass("rotate"):a.removeClass("rotate"),a.cropbox({width:e,height:d})}),$(document).on("click","#toptext-confirm",function(){toptext=$("#toptextedit").val(),updateTopText(toptext),$(".edittoptext").remove()}),$("#background").on("change",function(){$(this).val()=="trans"?(backgroundcolor="#FFFFFF",$("#day-color").val()=="#FFFFFF"&&$("#day-color").val("#010101").css({background:"#000",color:"#fff"}),$("#color").val()=="#FFFFFF"&&($("#color").val("#010101").css({background:"#000",color:"#fff"}),setupTemplateColor()),$("#text-color").val()=="#FFFFFF"&&$("#text-color").val("#010101").css({background:"#000",color:"#fff"}),setupText(),$(".dagenidag, .Dato").css({color:"black"}),$("table.grid td").css({"border-color":"white"}),$("div.editorcontainer").addClass("transparent").removeClass("black")):$(this).val()=="white"?(backgroundcolor="#FFFFFF",$("#day-color").val()=="#FFFFFF"&&$("#day-color").val("#010101").css({background:"#000",color:"#fff"}),$("#color").val()=="#FFFFFF"&&($("#color").val("#010101").css({background:"#000",color:"#fff"}),setupTemplateColor()),$("#text-color").val()=="#FFFFFF"&&$("#text-color").val("#010101").css({background:"#000",color:"#fff"}),setupText(),$(".dagenidag, .Dato").css({color:"#cccccc"}),$("table.grid td").css({"border-color":"white"}),$("div.editorcontainer").removeClass("transparent").removeClass("black")):$(this).val()=="black"&&(backgroundcolor="#000000",$("#day-color").val()=="#010101"&&$("#day-color").val("#FFFFFF").css({background:"#fff",color:"#000"}),$("#color").val()=="#010101"&&($("#color").val("#FFFFFF").css({background:"#fff",color:"#000"}),setupTemplateColor()),$("#text-color").val()=="#010101"&&$("#text-color").val("#FFFFFF").css({background:"#fff",color:"#000"}),$(".editorcontainer").css({opacity:"1"}),setupText(),$(".dagenidag, .Dato").css({color:"#cccccc"}),$("table.grid td").css({"border-color":"black"}),$("div.editorcontainer").removeClass("transparent").addClass("black"))})}),$(window).load(function(){$(".loader").fadeOut()})