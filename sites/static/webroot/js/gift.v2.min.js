function resizeText(a,b){$("#"+b).on("click",function(){$(".textholder").removeClass("activeText"),$(".update-text-func").show(),$(".add-text-func").hide();var a=$("#"+b).data("text");a=a.replace(/XXNYLINJEXX/g,"\n"),a=a.replace(/XXOGXX/g,"&"),$(this).addClass("activeText"),$("#new-text").val(a),$("#new-text-color").val("#"+$(this).data("color")),$(".colorPicker-picker").css("background-color","#"+$(this).data("color")),$("#fontselect").val($(this).data("font"));var c=convertAlignFromTaule($(this).data("gravity"));$("#new-text").css("text-align",c),$("#text-align-"+c).prop("checked",!0);var d=new Array($(".activeText").panzoom("getMatrix")),e=parseFloat(d[0][0]);$('input[name="text-size"').val(e)})}function resizeElement(a,b){$("#"+a).on("mouseenter mousedown",function(){$("#"+a).find(".ui-resizable-handle").show()}).mouseleave(function(){$("#"+a).find(".ui-resizable-handle").hide()}),$("#"+a).on("touchstart click",function(){$("#"+a).find(".ui-resizable-handle").show()}),$(document).on("touchstart mousedown",function(a){$(".ui-resizable-handle").hide()}),$("#"+a).find(".ui-resizable-ne").append('<img src="'+staticsite+'gfx/icons/resize.png""/>').css("display","none");var c=!1;$("#"+a).find(".ui-resizable-ne").on("mousedown touchstart",function(a){$("div").addClass("resizing"),$("#"+b).panzoom("disable"),c=!0}),$(document).on("mouseup touchend",function(a){$("div").removeClass("resizing"),$("#"+b).panzoom("enable"),c=!1}),$("#"+a).find(".delteclipart").on("mousedown touchstart",function(){$("#"+b).remove()});var d=0,e=0;$(document).on("mousemove touchmove",function(f){if(c==1){$("#"+b).panzoom("enable");var g=new Array($("#"+b).panzoom("getMatrix")),h=parseFloat(g[0][0]),i=d-f.pageY,j=e-f.pageX;console.log("move"),console.log(j),console.log(i),console.log(-i+j);if(-i+j<0){var k=0;i>j?k=i*.03:k=j*.03,h+=.02,$("#"+b).panzoom("zoom",h)}else h-=.02,$("#"+b).panzoom("zoom",h);$("#"+a).find(".ui-resizable-ne").show(),d=f.pageY,e=f.pageX,$(".currentclipart").focus(),f.preventDefault()}})}function stretchToFit(){if($("#template").data("websize_x")&&$("#template").data("websize_y")){$("#template-wrapper").width($("#template").data("websize_x")),$("#template-wrapper").height($("#template").data("websize_y")),$("#template").width($("#template").data("websize_x")),$("#template").height($("#template").data("websize_y"));var a=parseFloat($("#template").data("websize_x")),b=parseFloat($("#template").data("websize_y"));if(a>b)var c=$("#template").data("fullsize_x")/maxtemplatewidt;else var c=$("#template").data("fullsize_y")/maxHeight;var d=parseFloat($("#template").data("fullsize_pos_x")/c),e=parseFloat($("#template").data("fullsize_pos_y")/c),f=parseFloat($("#template").data("fullsize_pos_dx")/c),g=parseFloat($("#template").data("fullsize_pos_dy")/c)}else{var a=parseFloat($("#original-template-width").val()),b=parseFloat($("#original-template-height").val());if(a>b)var c=$("#original-template-width").val()/maxtemplatewidt;else var c=$("#original-template-height").val()/maxHeight;var d=parseFloat($("#original-pos-x").val()/c),e=parseFloat($("#original-pos-y").val()/c),f=parseFloat($("#original-pos-dx").val()/c),g=parseFloat($("#original-pos-dy").val()/c)}if($("#template").height()>=maxHeight){var h=$("#template").height()/maxHeight;$("#template").height(maxHeight),$("#template").width($("#template").width()/h),$("#template-wrapper").css("margin-left",parseFloat(maxtemplatewidt-$("#template").width())/2)}else if($("#template").width()>=maxtemplatewidt){var h=$("#template").width()/maxtemplatewidt;$("#template").height($("#template").height()/h),$("#template").width(maxtemplatewidt)}else $("#template-wrapper").css("margin-left","0");$("#template-wrapper").css("margin-left","0");var i=g,j=f;if($("#image").width()>=$("#image").height()){var k=f/g,l=$("#image").width()/$("#image").height();k>l?(i=parseFloat(f/l),e-=(i-g)/2):(j=parseFloat(g*l),d-=(j-f)/2)}else{var l=$("#image").height()/$("#image").width(),k=g/f;l>=k?(i=parseFloat(f*l),e-=(i-g)/2):(j=parseFloat(g/l),d-=(j-f)/2)}$("#image").width(j),$("#image").height(i),$("#image").css("left",d),$("#image").css("top",e),$("#helper").width(j).css("left",parseInt(d)),$("#helper").height(i).css("top",parseInt(e)),$("#template").width()&&$("#image").width()&&($("#helper").width(j),$("#helper").height(i),helpertop=parseInt($("#helper").css("top")),helperleft=parseInt($("#helper").css("left")),helpertwidth=parseInt($("#helper").css("width")),helperheight=parseInt($("#helper").css("height")),$("#template-wrapper").width($("#template").width()),$("#template-wrapper").height($("#template").height())),$(".row-offcanvas").hasClass("active")&&$(".row-offcanvas").toggleClass("active"),$(window).scrollTop(100)}function getImage(a){var b=400,c=maxtemplatewidt;return"/images/stream/image/"+a+"/"+c+"/"+b}function convertAlignToTaule(a){return a=="left"?"West":a=="center"?"Center":a=="right"?"East":"West"}function convertAlignFromTaule(a){return a=="West"?"left":a=="Center"?"center":a=="East"?"right":"West"}function save(){var a=$("#original-template-width").val()/$("#template").width(),b=$("#original-template-height").val()/$("#template").height(),c=$("#image").position(),d=new Array;d.push(),d[0]=new Object,d[0].malid=$("#template").data("malid"),d[0].malpageid=$("#template").data("malpageid"),d[0].giftQuantity=$("#gift-quantity").val(),d[0].productoptionid=$("#productoptionid").val(),d[0].productid=$("#productid").val(),d[0].size="small",d[0].editor_x=$("#template-wrapper").width(),d[0].editor_y=$("#template-wrapper").height(),$("#red-eye").is(":checked")&&(d[0].redeye="true"),d[0].image=new Object,d[0].image.x=c.left*a,d[0].image.y=c.top*b,d[0].image.dx=$("#image").width()*a,d[0].image.dy=$("#image").height()*b,d[0].image.bid=$("#selected-image").val(),d[0].texts=new Array,$(".textholder").each(function(c){var e=$(this).position(),f=new Object;f.text=Base64.encode($(this).data("text")),f.font=$(this).data("font"),f.color=$(this).data("color"),f.gravity=$(this).data("gravity"),f.zindex=$(this).data("zindex");var g=new Array($(this).panzoom("getMatrix")),h=$(this).width()*g[0][0],i=$(this).height()*g[0][0];f.x=e.left*a,f.y=e.top*b,f.dx=h*a,f.dy=i*b,d[0].texts.push(f)}),d[0].cliparts=new Array,$(".currentclipartholder").each(function(c){var e=$(this).position(),f=new Object,g=new Array($(this).panzoom("getMatrix")),h=$(this).find(".currentclipart").width()*g[0][0],i=$(this).find(".currentclipart").height()*g[0][0];f.id=$(this).data("id"),f.x=e.left*a,f.y=e.top*a,f.dx=h*a,f.dy=i*b,f.zindex=$(this).data("zindex"),d[0].cliparts.push(f)}),$("input[name='name']").val()&&(d[0].name=$("input[name='name']").val(),d[0].font=$("input[name='font']:checked").val()),$.ajax({type:"POST",url:"/create/gift/save",dataType:"JSON",data:{pages:$.toJSON(d)},success:function(a){return document.location.href="/cart/accessories/",!1},complete:function(a){},error:function(a){alert("error")}})}var helpertop,helperleft,helpertwidth,helperheight;$(document).ready(function(){$("#accordion").accordion({navigation:!0,heightStyle:"content"}),location.hash.toLowerCase().substring(1)=="choose-template"&&$("#accordion").accordion("activate",1),$.post("/api/1.0/prices/get",{productoptionid:1417,quantity:1},function(a){$("#redeye-price").text(a.price)},"json"),$(".quantity").bind("change",function(){var a=$(this).val();$.post("/api/1.0/prices/get",{productoptionid:productoptionid,quantity:a},function(a){$("#gift-price").text(a.price)},"json")}),$("#helper").on("panzoomchange",function(a,b,c,d){var e=new Array(c),f=parseInt($(this).width())*e[0][0],g=parseInt($(this).height())*e[0][0],h=parseInt($(this).css("top"))+parseInt(parseInt(e[0][5])+(helperheight-g)/2),i=parseInt($(this).css("left"))+parseInt(parseInt(e[0][4])+(helpertwidth-f)/2);$("#image").css({top:h,left:i,"margin-left":0,"margin-top":0,width:f,height:g})});var a=1,b=210;$("#add-gift-to-cart").click(function(){save()}),$("#template").data("malid",$("#initMalid").val()),$("#template").data("malpageid",$("#initMalpageid").val()),$("#select-album").bind("change",function(){$("#album-images").empty(),$("#album-images").append('<div class="loader center prepend-top"><img src="'+bigajaxLoader+'" title="loading" /></div>'),$.getJSON("/api/1.0/album/images/forpurchase/"+$(this).val(),function(a){a.result?($.each(a.images,function(a,b){$("#album-images").append('<img src="'+b.thumbnail+'" title="'+b.title+'" id="'+b.id+'"height="50" />')}),$(".loader","#album-images").remove()):($("#album-images").empty(),$("#album-images").append('<h3 class="prepend-top center">'+noImagesText+"</h3>"))})}),$(".text-align","#text-align").click(function(){$(this).hasClass("left")?$("#new-text").css("text-align","left"):$(this).hasClass("center")?$("#new-text").css("text-align","center"):$("#new-text").css("text-align","right")}),$(document).on("click",".template-thumb,#choose-template",function(){$("#template").remove(),$("#template-wrapper").prepend('<div id="template-ajax-loader"><img src="'+bigajaxLoaderGray+'"/></div>');var a=this,b=$(".mal",a).data("websize_x"),c=$(".mal",a).data("websize_y");$("#template-ajax-loader").css("opacity","0.8").css("margin","0").css("background-color","#666").css("padding-left",b/2).css("padding-top",c/2).css("z-index","34000").width("100%").height("100%");var d=new Image;return $(d).load(function(){$("#template-ajax-loader").remove(),$("#image-wrapper").before('<img id="template" src="" height="'+c+'" width="'+b+'" style="height:'+c+"px ; width:"+b+'px "/>'),$("#template").addClass("highrestemplate"),$("#template").attr("src",$(".highres",a).attr("href")),$("#template").data("malid",$(".malid",a).val()),$("#template").data("websize_x",b),$("#template").data("websize_y",c),$("#template").data("fullsize_pos_x",$(".mal",a).data("fullsize_pos_x")),$("#template").data("fullsize_pos_y",$(".mal",a).data("fullsize_pos_y")),$("#template").data("fullsize_pos_dx",$(".mal",a).data("fullsize_pos_dx")),$("#template").data("fullsize_pos_dy",$(".mal",a).data("fullsize_pos_dy")),$("#template").data("fullsize_x",$(".mal",a).data("fullsize_x")),$("#template").data("fullsize_y",$(".mal",a).data("fullsize_y")),$("#template").width(b),$("#template").height(c),$("#template").data("malid",$(".malid",a).val()),$("#template").data("malpageid",$(".malpageid",a).val()),$("#original-template-width").val($(".mal",a).data("fullsize_x")),$("#original-template-height").val($(".mal",a).data("fullsize_y")),stretchToFit()}).attr("src",$(".highres",a).attr("href")),!1}),$(document).on("click","#album-images img",function(){$("#template-wrapper").prepend('<div id="template-ajax-loader"><img src="'+bigajaxLoaderGray+'"/></div>'),$("#template-ajax-loader").css("opacity","0.8").css("margin","0").css("background-color","#666").css("padding-left",$("#template-wrapper").width()/2).css("padding-top",$("#template-wrapper").height()/2).css("z-index","34000").width("100%").height("100%"),$("#image").remove(),$("#image-wrapper").append('<img id="image" />');var a=new Image;$(a).load(function(){$("#template-ajax-loader").remove(),stretchToFit()}).attr("src",getImage($(this).attr("id"))),$("#image").attr("src",$(this).attr("src")),$("#selected-image").val($(this).attr("id")),$("#image").attr("src",getImage($(this).attr("id")));var b=this;$("#choose-template .template-thumb").css("background-image","url("+$(this).attr("src")+")"),$("#image").load(function(){stretchToFit()}),stretchToFit()}),$("button#velgbilde").on("click",function(){return $("#choosefile").click(),!1}),$("input#choosefile").on("change",function(){return $("#lastoppbilde").click(),!1}),$("#fileupload").fileupload({replaceFileInput:!1,dataType:"json",datatype:"json",xhrFields:{withCredentials:!0},acceptFileTypes:/(\.|\/)(jpe?g|tif)$/i,add:function(a,b){b.context=$('<p id="uploading" style="position: absolute; left: 20px;"/>').text("Uploading...").appendTo($(".progress-bar")),b.submit(),$(".progress").show(),$(".progress .progress-bar-success").css("width","0%")},done:function(a,b){$("#uploading").remove(),$.each(b.result.files,function(a,b){var c='<img class="imagethumb" id="'+b.id+'"src="'+b.thumbnailUrl+'" style="height: 75px"  />';$("#upload-queue").append(c),selectedImageId=$(this).attr("id");var d=this;$("#choose-template .template-thumb").css("background-image","url("+b.thumbnailUrl+")"),$("img#"+b.id).css("border-color","#0199d8"),$(".progress").hide()})},progressall:function(a,b){var c=parseInt(b.loaded/b.total*100,10);$(".progress .progress-bar-success").css("width",c+"%")}}),$(document).on("click","#upload-queue img",function(){var a=$(this).attr("id");$("#image").remove(),$("#image").attr("src",$(this).attr("src")),$("#selected-image").val(a);var b=new Image;$(b).load(function(){$("#image-wrapper").append('<img id="image" />'),$("#image").attr("src",getImage(a)),$("#helper").width(b.width),$("#helper").height(b.height),stretchToFit()}).attr("src",getImage(a))}),$("#update-text").click(function(){var a=$(".activeText").find("img"),c=$("#new-text").val();if(c!=""){c=c.replace(/\n/g,"XXNYLINJEXX"),c=c.replace("&","XXOGXX"),c=c.replace(/\\/g,"\\\\"),c=c.replace(/\'/g,"\\'"),c=c.replace(/\"/g,'\\"'),c=c.replace(/\0/g,"\\0");var d=$("#new-text-color").val().replace("#",""),e=$("#fontselect").val(),f=convertAlignToTaule($("#new-text").css("text-align")),g=$(".activeText");png=1,a.attr("src","/api/1.0/gift/text/?id=0&quality=1&png="+png+"&font="+e+"&gravity="+f+"&color="+d+"&text="+c+"&encoding=UTF8"),$(".activeText").data("text",c),$(g).data("font",e),$(g).data("gravity",f),$(g).data("color",d),$(g).data("text",c),$(g).data("zindex",b)}}),$("body").on("click",function(a){$(a.target).closest("#template-wrapper").length==1&&!$(a.target).hasClass("gifteditor_text")&&$(".textholder").hasClass("activeText")&&($(".textholder").removeClass("activeText"),$(".update-text-func").hide(),$(".add-text-func").show())}),$("#delete-text").on("click",function(){$(".activeText").remove(),$(".update-text-func").hide(),$(".add-text-func").show()});var c=!1;$('input[name="text-size"]').on("mousedown touchstart",function(){c=!0}),$('input[name="text-size"]').on("mouseup touchend",function(){c=!1}),$('input[name="text-size"]').on("change mousemove",function(){var a=$(this).val(),b=new Array($(".activeText").panzoom("getMatrix")),c=parseFloat(b[0][0]);b[0][0]=a,b[0][3]=a,$(".activeText").panzoom("setMatrix",b)}),$("#add-text").click(function(){var c="currentResizable"+a+"-"+b,d=$("#new-text").val();if(d!=""){d=d.replace(/\n/g,"XXNYLINJEXX"),d=d.replace("&","XXOGXX"),d=d.replace(/\\/g,"\\\\"),d=d.replace(/\'/g,"\\'"),d=d.replace(/\"/g,'\\"'),d=d.replace(/\0/g,"\\0");var e=$("#new-text-color").val().replace("#",""),f=$("#fontselect").val(),g=convertAlignToTaule($("#new-text").css("text-align"));$("#template-wrapper").append('<div id="textholder'+a+'" class="textholder draggable activeText" data-text="'+d+'">\t\t\t\t\t\t\t<div id="'+c+'" class="resizable">\t\t\t\t\t\t\t\t<img id="text'+a+'" class="currenttext img"/>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>'),$("#text"+a).addClass("gifteditor_text"),$(".update-text-func").show(),$(".add-text-func").hide(),resizeText(c,"textholder"+a),png=1,$("#text"+a).attr("src","/api/1.0/gift/text/?id=0&quality=1&png="+png+"&font="+f+"&gravity="+g+"&color="+e+"&text="+d+"&encoding=UTF8");var h=$("#textholder"+a);$(h).css({"z-index":"20"+a,position:"absolute",top:0,left:0}),$(h).data("font",f),$(h).data("gravity",g),$(h).data("color",e),$(h).data("text",d),$(h).data("zindex",b),$(h).panzoom({minScale:.1,maxScale:3}),$(h).panzoom("setMatrix",[.7,0,0,.7,50,50]),$("#new-text").val(""),a++,b++}$(".row-offcanvas").hasClass("active")&&$(".row-offcanvas").toggleClass("active")}),$("#helper").width($("#image").width()),$("#helper").height($("#image").height()),$("#helper").panzoom({minScale:.05,$zoomIn:$(".zoom-in"),$zoomOut:$(".zoom-out"),$zoomRange:$(".zoom-range"),$reset:$(".reset")}),$("#see-throug-template").click(function(){$(this).hasClass("clicked")?($("#template").fadeTo("slow",1),$(this).removeClass("clicked")):($("#template").fadeTo("slow",.7),$(this).addClass("clicked"))}),$("#clipartgroup-selector").on("change",function(){var a=$(":selected",this).val();$("#clipart-selector .clipartcollection").hide(),$("#clipartcollection_id_"+a).css("display","block"),$("img","#clipartcollection_id_"+a).css("display","block"),$("#clipartcollection_id_"+a).show(),$("#clipart-selector .clipartcollection img").each(function(a,b){$(b).attr("src",$(b).attr("title"))})}),$(document).on("click","#clipart-selector .clipartitem-container",function(){var a=$(this).attr("id").replace("clipartitem-container_",""),c="currentclipart"+a+"-"+b,d="currentResizable"+a+"-"+b,e="currentDraggable"+a+"-"+b;$("#template-wrapper").append('<div id="'+e+'" class="draggable currentclipartholder" data-id="'+a+'" ">\t\t\t\t\t\t\t\t\t\t\t<div id="'+d+'" class="resizable">\t\t\t\t\t\t\t\t\t\t\t\t<img id="'+c+'" class="currentclipart"/>\t\t\t\t\t\t\t\t\t\t\t\t<div class="ui-resizable-handle ui-resizable-ne" style="z-index: 1000;"></div>\t\t\t\t\t\t\t\t\t\t\t\t<div class="ui-resizable-handle ui-resizable-nw delteclipart" style="z-index: 1000;">\t\t\t\t\t\t\t\t\t\t\t\t\t<img src="'+staticsite+'gfx/icons/delete.png" />\t\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t\t</div>');var f=staticurl+"images/clipart/thumbs/width/300/"+a.toString()+".png";resizeElement(d,e);var g=$("#currentclipart"+a+"-"+b);$("#"+e).panzoom({minScale:.1,maxScale:3}),$("#"+e).css({position:"absolute","z-index":b,top:0,left:0}).addClass("selectedclip"),g.attr("src",f),$("#"+e).panzoom("setMatrix",[.4,0,0,.4,50,50]),b++,$(".row-offcanvas").hasClass("active")&&$(".row-offcanvas").toggleClass("active")}),$("#select-album").trigger("change")}),$(window).load(function(){stretchToFit(),$(window).scrollTop(100)});var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b="",c,d,e,f,g,h,i,j=0;a=Base64._utf8_encode(a);while(j<a.length)c=a.charCodeAt(j++),d=a.charCodeAt(j++),e=a.charCodeAt(j++),f=c>>2,g=(c&3)<<4|d>>4,h=(d&15)<<2|e>>6,i=e&63,isNaN(d)?h=i=64:isNaN(e)&&(i=64),b=b+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h)+this._keyStr.charAt(i);return b},decode:function(a){var b="",c,d,e,f,g,h,i,j=0;a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(j<a.length)f=this._keyStr.indexOf(a.charAt(j++)),g=this._keyStr.indexOf(a.charAt(j++)),h=this._keyStr.indexOf(a.charAt(j++)),i=this._keyStr.indexOf(a.charAt(j++)),c=f<<2|g>>4,d=(g&15)<<4|h>>2,e=(h&3)<<6|i,b+=String.fromCharCode(c),h!=64&&(b+=String.fromCharCode(d)),i!=64&&(b+=String.fromCharCode(e));return b=Base64._utf8_decode(b),b},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");var b="";for(var c=0;c<a.length;c++){var d=a.charCodeAt(c);d<128?b+=String.fromCharCode(d):d>127&&d<2048?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(d&63|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(d&63|128))}return b},_utf8_decode:function(a){var b="",c=0,d=c1=c2=0;while(c<a.length)d=a.charCodeAt(c),d<128?(b+=String.fromCharCode(d),c++):d>191&&d<224?(c2=a.charCodeAt(c+1),b+=String.fromCharCode((d&31)<<6|c2&63),c+=2):(c2=a.charCodeAt(c+1),c3=a.charCodeAt(c+2),b+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63),c+=3);return b}}