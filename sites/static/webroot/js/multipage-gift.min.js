function stretchToFit(){var a=$(".selected-template").find("#template"),b=$(".selected-template").find("#image"),c=$(".selected-template").find(".helper");$(".selected-template").addClass("stretchToFit");if(a.data("websize_x")&&a.data("websize_y")){$(".selected-template").width(a.data("websize_x")),$(".selected-template").height(a.data("websize_y")),a.width(a.data("websize_x")),a.height(a.data("websize_y"));var d=parseFloat(a.data("websize_x")),e=parseFloat(a.data("websize_y"));if(d>e)var f=a.data("fullsize_x")/630;else var f=a.data("fullsize_y")/maxHeight;var g=parseFloat(a.data("fullsize_pos_x")/f),h=parseFloat(a.data("fullsize_pos_y")/f),i=parseFloat(a.data("fullsize_pos_dx")/f),j=parseFloat(a.data("fullsize_pos_dy")/f)}else{var d=parseFloat($("#original-template-width").val()),e=parseFloat($("#original-template-height").val());if(d>e)var f=$("#original-template-width").val()/630;else var f=$("#original-template-height").val()/maxHeight;var g=parseFloat($(".selected-template").find("#original-pos-x").val()/f),h=parseFloat($(".selected-template").find("#original-pos-y").val()/f),i=parseFloat($(".selected-template").find("#original-pos-dx").val()/f),j=parseFloat($(".selected-template").find("#original-pos-dy").val()/f)}if(a.height()>=maxHeight){if(!ie6){var k=a.height()/maxHeight;a.height(maxHeight),a.width(a.width()/k),$(".selected-template").css("margin-left",parseFloat(630-a.width())/2)}}else $(".selected-template").css("margin-left","0");var l=j,m=i;if(b.width()>=b.height()){var n=i/j,o=b.width()/b.height();n>o?(l=parseFloat(i/o),h-=(l-j)/2):(m=parseFloat(j*o),g-=(m-i)/2)}else{var o=b.height()/b.width(),n=j/i;o>=n?(l=parseFloat(i*o),h-=(l-j)/2):(m=parseFloat(j/o),g-=(m-i)/2)}b.width(m),b.height(l),b.css("left",g),b.css("top",h),c.width(m).css("left",parseInt(g)),c.height(l).css("top",parseInt(h)),a.width()&&b.width()&&(c.width(m),c.height(l),$(".selected-template").width($("#template").width()),$(".selected-template").height($("#template").height()),ie6&&a.data("websize_x")&&a.data("websize_y")&&($(".selected-template").width(a.data("websize_x")),$(".selected-template").height(a.data("websize_y"))))}function getImage(a){var b=400,c=630;return"/images/stream/image/"+a+"/"+c+"/"+b}function startZoomIn(){zoomTimer&&endZoom(),isZooming=!0,setTimeout("zoomIn()",20)}function startZoomOut(){zoomTimer&&endZoom(),isZooming=!0,setTimeout("zoomOut()",20)}function endZoom(){zoomTimer&&(clearTimeout(zoomTimer),zoomTimer=!1),isZooming=!1}function zoomIn(a){var b=$(".selected-template").find("#image"),c=$(".selected-template").find(".helper");b.width(b.width()+b.width()/50),b.height(b.height()+b.height()/50),c.width(b.width()),c.height(b.height()),isZooming&&(zoomTimer&&(clearTimeout(zoomTimer),zoomTimer=!1),zoomTimer=setTimeout("zoomIn('#image')",20))}function zoomOut(a){var b=$(".selected-template").find("#image"),c=$(".selected-template").find(".helper");b.width(b.width()-b.width()/50),b.height(b.height()-b.height()/50),c.width(b.width()),c.height(b.height()),isZooming&&(zoomTimer&&(clearTimeout(zoomTimer),zoomTimer=!1),zoomTimer=setTimeout("zoomOut('#image')",20))}function convertAlignToTaule(a){return a=="left"?"West":a=="center"?"Center":a=="right"?"East":"West"}function save(){var a=new Array;a.push();var b=0;$(".template").each(function(){var c=$(this).find("#template"),d=$(this).find("#initMalpageid").val(),e=$(this).find("#initMalid").val(),f=$(this).find("#original-template-width").val()/c.width(),g=$(this).find("#original-template-height").val()/c.height(),h=$(this).find("#image").position(),j=$(this).find("#image").css("left").replace("px",""),k=$(this).find("#image").css("top").replace("px",""),l=$(this).find("#image").css("width").replace("px",""),m=$(this).find("#image").css("height").replace("px",""),n=$(this).find("#image"),o=$(this).find("#selected-image");a[b]=new Object,a[b].malid=e,a[b].malpageid=d,a[b].giftQuantity=$("#gift-quantity").val(),a[b].productoptionid=$("#productoptionid").val(),a[b].productid=$("#productid").val(),a[b].size="small",a[b].editor_x=$(this).width(),a[b].editor_y=$(this).height(),$("#red-eye").is(":checked")&&(a[b].redeye="true"),a[b].image=new Object,a[b].image.x=j*f,a[b].image.y=k*g,a[b].image.dx=l*f,a[b].image.dy=m*g,a[b].image.bid=o.val(),a[b].texts=new Array,$(this).find(".textholder").each(function(c){var d=$(this).position(),e=$(this).css("left").replace("px",""),h=$(this).css("top").replace("px",""),j=$(this).find(".currenttext"),k=parseInt($("body").find(j).height()),l=parseInt($("body").find(j).width()),m=new Object;m.text=Base64.encode($(this).data("text")),m.font=$(this).data("font"),m.color=$(this).data("color"),m.gravity=$(this).data("gravity"),m.zindex=$(this).data("zindex"),m.x=e*f,m.y=h*g,m.dx=l*f,m.dy=k*g,a[b].texts.push(m)}),a[b].cliparts=new Array,$(this).find(".currentclipartholder").each(function(c){var d=$(this).position(),e=$(this).css("left").replace("px",""),h=$(this).css("top").replace("px",""),j=$(this).find(".currentclipart"),k=parseInt($("body").find(j).height()),l=parseInt($("body").find(j).width()),m=new Object;m.id=$(this).data("id"),m.x=e*f,m.y=h*f,m.dx=l*f,m.dy=k*g,m.zindex=$(this).data("zindex"),a[b].cliparts.push(m)}),b++}),$.ajax({type:"POST",url:"/create/newgift/save",dataType:"JSON",data:{pages:$.toJSON(a)},success:function(a){return document.location.href="/cart/accessories/",!1},complete:function(a){},error:function(a){alert("error")}})}var me=this;$(document).ready(function(){$("#font-list").fontmenu(),$(".template").first().show().addClass("selected-template"),$(".select-page").first().addClass("selected-pageselect"),$("#nextindex").on("click",function(){var a=$(".selected-pageselect").attr("index");return a++,$("a[index='"+a+"']").click(),!1}),$("#previndex").on("click",function(){var a=$(".selected-pageselect").attr("index");return a--,$("a[index='"+a+"']").click(),!1}),$(".select-page").on("click",function(){$(".selected-template").find(".currentclipartholder").each(function(){var a=$(this).find(".currentclipart"),b=a.height();a.css("height",b)}),$(".selected-template").find(".textholder").each(function(){var a=$(this).find(".currenttext ");a.css("height",a.height())}),$(".select-page").each(function(){$(this).removeClass("selected-pageselect")}),$(this).addClass("selected-pageselect");var a=$(this).attr("id").split("-");return $(".template").each(function(){$(this).hide().removeClass("selected-template")}),$(".template-wrapper-"+a[2]).show().addClass("selected-template"),$(".selected-template").hasClass("stretchToFit")||stretchToFit(),$(".selected-template").find(".helper").width($("#image").width()),$(".selected-template").find(".helper").height($("#image").height()),!1}),$("#accordion").accordion({navigation:!0}),location.hash.toLowerCase().substring(1)=="choose-template"&&$("#accordion").accordion("activate",1),$.post("/api/1.0/prices/get",{productoptionid:1417,quantity:1},function(a){$("#redeye-price").text(a.price)},"json"),$(".quantity").bind("change",function(){var a=$(this).val();$.post("/api/1.0/prices/get",{productoptionid:productoptionid,quantity:a},function(a){$("#gift-price").text(a.price)},"json")});var a=1,b=210;$("#add-gift-to-cart").click(function(){var a=new Array,b=0;$(".template").each(function(){var c=$(this).find("#selected-image").val();b++,$(this).find("#image").hasClass("noimage")&&c==0&&a.push(b)});if(a.length>0){var c=a.join();$("#missing").text(c),$("#dialog-confirm").dialog({resizable:!1,height:200,modal:!0,buttons:{OK:function(){$(this).dialog("close")}}})}else save();return!1}),ie6&&$("#template-wrapper").ready(function(){$("#template-wrapper").pngFix()}),$("#template-wrapper").load(function(){ie6&&$("#template-wrapper").pngFix()}),$("#template").data("malid",$("#initMalid").val()),$("#template").data("malpageid",$("#initMalpageid").val()),$("#select-album").bind("change",function(){$("#album-images").empty(),$("#album-images").append('<div class="loader center prepend-top"><img src="'+bigajaxLoader+'" title="loading" /></div>'),$.getJSON("/api/1.0/album/images/forpurchase/"+$(this).val(),function(a){a.result?($.each(a.images,function(a,b){$("#album-images").append('<img src="'+b.thumbnail+'" title="'+b.title+'" id="'+b.id+'"height="50" />')}),$(".loader","#album-images").remove()):($("#album-images").empty(),$("#album-images").append('<h3 class="prepend-top center">'+noImagesText+"</h3>"))})}),$(".text-align","#text-align").click(function(){$(this).hasClass("left")?$("#new-text").css("text-align","left"):$(this).hasClass("center")?$("#new-text").css("text-align","center"):$("#new-text").css("text-align","right")}),$(".template-thumb-fail","#choose-template-fail").live("click",function(){var a=this;return $(".template").each(function(b,c){$this=$(c),$template=$(c).find("#template"),$imagewrapper=$(c).find("#image-wrapper"),$template.remove();var d=$(".mal",a).data("websize_x"),e=$(".mal",a).data("websize_y"),f=new Image;$imagewrapper.before('<img id="template" src="" height="'+e+'" width="'+d+'" style="height:'+e+"px ; width:"+d+'px "/>'),$template=$this.find("#template"),$template.addClass("highrestemplate"),$template.attr("src",$(".highres",a).attr("href")),$template.data("malid",$(".malid",a).val()),$template.data("websize_x",d),$template.data("websize_y",e),$template.data("fullsize_pos_x",$(".mal",a).data("fullsize_pos_x")),$template.data("fullsize_pos_y",$(".mal",a).data("fullsize_pos_y")),$template.data("fullsize_pos_dx",$(".mal",a).data("fullsize_pos_dx")),$template.data("fullsize_pos_dy",$(".mal",a).data("fullsize_pos_dy")),$template.data("fullsize_x",$(".mal",a).data("fullsize_x")),$template.data("fullsize_y",$(".mal",a).data("fullsize_y")),$template.width(d),$template.height(e),$template.data("malid",$(".malid",a).val()),$template.data("malpageid",$(".malpageid",a).val()),$("#original-template-width").val($(".mal",a).data("fullsize_x")),$("#original-template-height").val($(".mal",a).data("fullsize_y")),ie6&&($(".highrestemplate").remove(),$(this).append('<img id="template" class="highrestemplate"/>'),$template.attr("src",$(".highres",a).attr("href")),$(this).pngFix(),$template.width(d),$template.height(e)),stretchToFit()}),!1}),$("img","#album-images").live("click",function(){$(".selected-template").prepend('<div id="template-ajax-loader"><img src="'+bigajaxLoaderGray+'"/></div>'),$("#template-ajax-loader").css("opacity","0.8").css("margin","0").css("background-color","#666").css("padding-left",$("#template-wrapper").width()/2).css("padding-top",$("#template-wrapper").height()/2).css("z-index","34000").width("100%").height("100%"),$(".selected-template").find("#image").remove(),$(".selected-template").find("#image-wrapper").append('<img id="image" />');var a=new Image;$(a).load(function(){$("#template-ajax-loader").remove(),stretchToFit()}).attr("src",getImage($(this).attr("id"))),$(".selected-template").find("#image").attr("src",$(this).attr("src")),$(".selected-template").find("#selected-image").attr("value",$(this).attr("id")),$(".selected-template").find("#image").attr("src",getImage($(this).attr("id")));var b=this;$("#choose-template .template-thumb").css("background-image","url("+$(this).attr("src")+")"),$(".selected-template").find("#image").load(function(){stretchToFit()}),stretchToFit()}),$("img","#upload-queue").live("click",function(){var a=$(this).attr("id");$(".selected-template").find("#image").remove(),$(".selected-template").find("#image").remove(),$(".selected-template").find("#image-wrapper").append('<img id="image" />');var b=new Image;$(b).load(function(){$("#template-ajax-loader").remove(),stretchToFit()}).attr("src",getImage($(this).attr("id"))),$(b).load(function(){$(".selected-template").find("#image-wrapper").append('<img id="image" />'),$(".selected-template").find("#selected-image").attr("value",a),$(".selected-template").find("#image").attr("src",getImage(a)),$(".helper").width(b.width),$(".helper").height(b.height),stretchToFit()}).attr("src",getImage(a))}),$("#add-text").click(function(){$(".selected-template").prepend('<div id="textholder'+a+'" class="textholder"/>'),$("#textholder"+a).prepend('<img id="text'+a+'" class="currenttext"/>');var c=$("#new-text").val();if(c!=""){c=c.replace(/\n/g,"XXNYLINJEXX"),c=c.replace("&","XXOGXX"),c=c.replace(/\\/g,"\\\\"),c=c.replace(/\'/g,"\\'"),c=c.replace(/\"/g,'\\"'),c=c.replace(/\0/g,"\\0");var d=$("#new-text-color").val().replace("#",""),e=$("#fontselect").val(),f=convertAlignToTaule($("#new-text").css("text-align"));$("#text"+a).addClass("gifteditor_text");var g;ie6?g=0:g=1,$("#text"+a).attr("src","/api/1.0/gift/text/?id=0&quality=1&png="+g+"&font="+e+"&gravity="+f+"&color="+d+"&text="+c+"&encoding=UTF8");var h=$("#textholder"+a);$(".currenttext",h).width($("#template").width()/3),$(h).css({"z-index":zindex,position:"absolute",top:$("#template").height()/3,left:$("#template").width()/3}),$(h).prepend('<div class="attached_edit_box" id="edit_text_'+a+'"></div>'),$(h).data("font",e),$(h).data("gravity",f),$(h).data("color",d),$(h).data("text",c),$(h).data("zindex",b),$(".attached_edit_box",h).prepend('<div class="sliderContainer"><img src="http://static.repix.no/gfx/gui/gifteditor_smaller_text.png" class="smallertext" /><div class="slider"></div><img src="http://static.repix.no/gfx/gui/gifteditor_larger_text.png" class="largertext" /></div>');var i=$(h).position();$(h).mouseenter(function(){$(".attached_edit_box",h).fadeTo("fast",.8),$("#template-wrapper").css("overflow","visible")}).mouseleave(function(){$(".attached_edit_box",h).fadeTo("fast",0),$("#template-wrapper").css("overflow","hidden")}),$(".attached_edit_box","#textholder"+a).append('<a href="#" class="delete button red x-small">'+deleteText+"</a>"),$("a.delete","#textholder"+a).click(function(){return $(h).remove(),!1}),$(h).draggable({containment:".selected-template",handle:".currenttext"}),$(".slider",h).slider({value:$(".currenttext",h).width(),max:$("#template").width(),min:50,slide:function(a,b){$(".gifteditor_text",h).css({width:b.value})}}),$("#new-text").attr("value",""),a++,b++,zindex++}}),$(".selected-template").find(".helper").width($("#image").width()),$(".selected-template").find(".helper").height($("#image").height()),$(".helper").each(function(){$(this).draggable({drag:function(a,b){var c=$(this).position();$(".selected-template").find("#image").css({top:c.top,left:c.left,"margin-left":0,"margin-top":0})}})}),$("#see-throug-template").click(function(){$(this).hasClass("clicked")?($("#template").fadeTo("slow",1),$(this).removeClass("clicked")):($("#template").fadeTo("slow",.7),$(this).addClass("clicked"))}),$("#zoom-in").bind("mousedown",function(){startZoomIn()}).bind("mouseup",function(){endZoom()}),$("#zoom-out").bind("mousedown",function(){startZoomOut()}).bind("mouseup",function(){endZoom()}),$("#clipartgroup-selector").bind("change",function(){var a=$(":selected",this).val();$("#clipart-selector .clipartcollection").hide(),$("#clipartcollection_id_"+a).css("display","block"),$("img","#clipartcollection_id_"+a).css("display","block"),$("#clipartcollection_id_"+a).show(),$("#clipart-selector .clipartcollection img").each(function(a,b){$(b).attr("src",$(b).attr("title"))})}),$(".clipartitem-container","#clipart-selector").live("click",function(){var a=$(this).attr("id").replace("clipartitem-container_","");$(".selected-template").prepend('<div id="clipartholder'+a+"-"+b+'" class="currentclipartholder"/>');var c=$("#clipartholder"+a+"-"+b);$(c).prepend('<img id="currentclipart'+a+"-"+b+'" class="currentclipart"/>'),$("img.currentclipart",c).attr("src",$("img",this).attr("src")),$(c).css({position:"absolute","z-index":zindex,top:50,left:50});var d=staticurl+"images/clipart/thumbs/width/300/"+a.toString()+".png";ie6&&(d="/clipart/"+a.toString()+"_thumb.gif",$("img.currentclipart",c).attr("src",d)),ie6||$("img.currentclipart",c).attr("src",d),$(".currentclipart",c).width(200),$(c).prepend('<div class="attached_edit_box" id="edit_clipart_'+a+'"></div>'),$(".attached_edit_box",c).prepend('<div class="sliderContainer"><img src="'+staticurl+'gfx/gui/gifteditor_smaller_text.png" class="smallertext" />'+'<div class="slider"></div>'+'<img src="'+staticurl+'gfx/gui/gifteditor_larger_text.png" class="largertext" />'+"</div>");var e=$(c).position(),f=c.height()/c.width();$(".slider",c).slider({value:$(c).width(),max:$("#template").width()-e.left,min:30,slide:function(a,b){$("img.currentclipart",c).css({width:b.value,height:f*b.value})}}),$(c).mouseenter(function(){$(".attached_edit_box",c).fadeTo("fast",.8),$("#template-wrapper").css("overflow","visible")}).mouseleave(function(){$(".attached_edit_box",c).fadeTo("fast",0),$("#template-wrapper").css("overflow","hidden")}),$(".attached_edit_box",c).append('<a href="#" class="delete button red x-small">Delete</a>'),$("a.delete",c).click(function(){return $(c).remove(),!1}),$(c).draggable({handle:".currentclipart"}),$(c).data("id",a),$(c).data("zindex",b),b++,zindex++}),$("#select-album").trigger("change")}),$(window).load(function(){stretchToFit()});var zoomTimer=!1,isZooming=!1,Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b="",c,d,e,f,g,h,i,j=0;a=Base64._utf8_encode(a);while(j<a.length)c=a.charCodeAt(j++),d=a.charCodeAt(j++),e=a.charCodeAt(j++),f=c>>2,g=(c&3)<<4|d>>4,h=(d&15)<<2|e>>6,i=e&63,isNaN(d)?h=i=64:isNaN(e)&&(i=64),b=b+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h)+this._keyStr.charAt(i);return b},decode:function(a){var b="",c,d,e,f,g,h,i,j=0;a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(j<a.length)f=this._keyStr.indexOf(a.charAt(j++)),g=this._keyStr.indexOf(a.charAt(j++)),h=this._keyStr.indexOf(a.charAt(j++)),i=this._keyStr.indexOf(a.charAt(j++)),c=f<<2|g>>4,d=(g&15)<<4|h>>2,e=(h&3)<<6|i,b+=String.fromCharCode(c),h!=64&&(b+=String.fromCharCode(d)),i!=64&&(b+=String.fromCharCode(e));return b=Base64._utf8_decode(b),b},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");var b="";for(var c=0;c<a.length;c++){var d=a.charCodeAt(c);d<128?b+=String.fromCharCode(d):d>127&&d<2048?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(d&63|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(d&63|128))}return b},_utf8_decode:function(a){var b="",c=0,d=c1=c2=0;while(c<a.length)d=a.charCodeAt(c),d<128?(b+=String.fromCharCode(d),c++):d>191&&d<224?(c2=a.charCodeAt(c+1),b+=String.fromCharCode((d&31)<<6|c2&63),c+=2):(c2=a.charCodeAt(c+1),c3=a.charCodeAt(c+2),b+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63),c+=3);return b}}