function timeout(a){var b=a.attr("id"),c=$(".selected-template .helper");holdbutton&&setTimeout(function(){a.click(),b=="zoom-in"?c.panzoom("zoom",!1):b=="zoom-out"?c.panzoom("zoom",!0):b=="reset"&&c.panzoom("reset");if(b!="zoom-range"){var d=c.panzoom("getMatrix")[0];$("#zoom-range").slider("value",d),timeout(a)}},10)}function setelementdata(a,b){var c=new Array(b),d=$(a).find(".img"),e=d.width()*parseFloat(c[0][0]),f=d.height()*parseFloat(c[0][0]),g=parseInt(c[0][4])+(d.width()-e)/2,h=parseInt(c[0][5])+(d.height()-f)/2;d.data({width:e,height:f,left:g,top:h})}function resizeText(a,b){$("#"+b).on("click",function(){$(".textholder").removeClass("activeText"),$(".update-text-func").show(),$(".add-text-func").hide();var a=$("#"+b).data("text");a=a.replace(/XXNYLINJEXX/g,"\n"),a=a.replace(/XXOGXX/g,"&"),$(this).addClass("activeText"),$("#new-text").val(a),$("#new-text-color").val("#"+$(this).data("color")),$(".colorPicker-picker").css("background-color","#"+$(this).data("color")),$("#fontselect").val($(this).data("font"));var c=convertAlignFromTaule($(this).data("gravity"));$("#new-text").css("text-align",c),$("#text-align-"+c).prop("checked",!0);var d=new Array($(".activeText").panzoom("getMatrix")),e=parseFloat(d[0][0]);$('input[name="text-size"').val(e)}),$("#"+b).on("panzoomchange",function(a,c,d,e){setelementdata("#"+b,d)})}function resizeElement(a,b){var c=0,d=0;$("#"+a).mouseenter(function(){$("#"+a).find(".ui-resizable-handle").show()}).mouseleave(function(){$("#"+a).find(".ui-resizable-handle").hide()}),$("#"+a).on("touchstart click",function(){$("#"+a).find(".ui-resizable-ne").show()}),$("#"+a).find(".ui-resizable-ne").append('<img class="icon" src="'+staticsite+'gfx/icons/resize.png" />').css("display","none");var e=!1;$("#"+a).find(".ui-resizable-ne").on("mousedown touchstart",function(a){a.preventDefault(),$("div").addClass("resizing"),$("#"+b).panzoom("disable"),e=!0,c=0,d=0}),$(document).on("mouseup touchend",function(a){$("div").removeClass("resizing"),$("#"+b).panzoom("enable"),e=!1}),$("#"+a).find(".delteclipart").on("click",function(){$("#"+b).remove()}),$(document).on("mousemove touchmove",function(f){if(e==1){d||(d=f.pageX),c||(c=f.pageY),$("#"+b).panzoom("enable");var g=new Array($("#"+b).panzoom("getMatrix")),h=parseFloat(g[0][0]),i=$("#"+b),j=i.panzoom("getMatrix"),k=$("#"+b).find(".ui-resizable-handle").width();$("#"+b).find(".ui-resizable-handle").width(25/j[0]);var l=i.width(),m=i.width()*j[0],n=f.pageX-d+(c-f.pageY),o=(m+n)/l;if(o<.15)return!1;i.panzoom("setMatrix",[o,0,0,o,j[4],j[5]]),$("#"+a).find(".ui-resizable-ne").show(),c=f.pageY,d=f.pageX,f.preventDefault()}}),setelementdata("#"+b,$("#"+b).panzoom("getMatrix")),$("#"+b).on("panzoomchange",function(a,c,d,e){setelementdata("#"+b,d)})}function stretchToFit(){var a=$(".selected-template").find("#template"),b=$(".selected-template").find("#image"),c=$(".selected-template").find(".helper");$(".selected-template").addClass("stretchToFit");if(a.data("websize_x")&&a.data("websize_y")){$(".selected-template").width(a.data("websize_x")),$(".selected-template").height(a.data("websize_y")),a.width(a.data("websize_x")),a.height(a.data("websize_y"));var d=parseFloat(a.data("websize_x")),e=parseFloat(a.data("websize_y"));if(d>e)var f=a.data("fullsize_x")/630;else var f=a.data("fullsize_y")/maxHeight;var g=parseFloat(a.data("fullsize_pos_x")/f),h=parseFloat(a.data("fullsize_pos_y")/f),i=parseFloat(a.data("fullsize_pos_dx")/f),j=parseFloat(a.data("fullsize_pos_dy")/f)}else{var d=parseFloat($("#original-template-width").val()),e=parseFloat($("#original-template-height").val());if(d>e)var f=$("#original-template-width").val()/630;else var f=$("#original-template-height").val()/maxHeight;var g=parseFloat($(".selected-template").find("#original-pos-x").val()/f),h=parseFloat($(".selected-template").find("#original-pos-y").val()/f),i=parseFloat($(".selected-template").find("#original-pos-dx").val()/f),j=parseFloat($(".selected-template").find("#original-pos-dy").val()/f)}if(a.height()>=maxHeight){if(!ie6){var k=a.height()/maxHeight;a.height(maxHeight),a.width(a.width()/k),$(".selected-template").css("margin-left",parseFloat(630-a.width())/2)}}else $(".selected-template").css("margin-left","0");var l=j,m=i;if(b.width()>=b.height()){var n=i/j,o=b.width()/b.height();n>o?(l=parseFloat(i/o),h-=(l-j)/2):(m=parseFloat(j*o),g-=(m-i)/2)}else{var o=b.height()/b.width(),n=j/i;o>=n?(l=parseFloat(i*o),h-=(l-j)/2):(m=parseFloat(j/o),g-=(m-i)/2)}b.width(m),b.height(l),b.css("left",g),b.css("top",h),c.width(m).css("left",parseInt(g)),c.height(l).css("top",parseInt(h)),a.width()&&b.width()&&(c.width(m),c.height(l),helpertop=parseInt(c.css("top")),helperleft=parseInt(c.css("left")),helpertwidth=parseInt(c.css("width")),helperheight=parseInt(c.css("height")),$(".selected-template").width($("#template").width()),$(".selected-template").height($("#template").height()),ie6&&a.data("websize_x")&&a.data("websize_y")&&($(".selected-template").width(a.data("websize_x")),$(".selected-template").height(a.data("websize_y"))));var p=c.parent().find("#initMalpageid").val();$("."+p+"-zoom-in").parent().removeClass("hide"),c.panzoom({increment:.005,minScale:.05,maxScale:4}),c.panzoom("reset");var q=c.panzoom("getMatrix")[0];$("#zoom-range").slider("value",q)}function getImage(a){var b=400,c=630;return"/images/stream/image/"+a+"/"+c+"/"+b}function convertAlignToTaule(a){return a=="left"?"West":a=="center"?"Center":a=="right"?"East":"West"}function convertAlignFromTaule(a){return a=="West"?"left":a=="Center"?"center":a=="East"?"right":"West"}function convertAlignToTaule(a){return a=="left"?"West":a=="center"?"Center":a=="right"?"East":"West"}function save(){var a=new Array;a.push();var b=0;$(".template").each(function(){var c=$(this).find("#template"),d=$(this).find("#initMalpageid").val(),e=$(this).find("#initMalid").val(),f=$(this).find("#original-template-width").val()/c.width(),g=$(this).find("#original-template-height").val()/c.height(),h=$(this).find("#image").position(),j=$(this).find("#image").css("left").replace("px",""),k=$(this).find("#image").css("top").replace("px",""),l=$(this).find("#image").css("width").replace("px",""),m=$(this).find("#image").css("height").replace("px",""),n=$(this).find("#image"),o=$(this).find("#selected-image");a[b]=new Object,a[b].malid=e,a[b].malpageid=d,a[b].giftQuantity=$("#gift-quantity").val(),a[b].productoptionid=$("#productoptionid").val(),a[b].productid=$("#productid").val(),a[b].size="small",a[b].editor_x=$(this).width(),a[b].editor_y=$(this).height(),$("#red-eye").is(":checked")&&(a[b].redeye="true"),a[b].image=new Object,a[b].image.x=j*f,a[b].image.y=k*g,a[b].image.dx=l*f,a[b].image.dy=m*g,a[b].image.bid=o.val(),a[b].texts=new Array,$(this).find(".textholder").each(function(c){var d=new Object;d.text=Base64.encode($(this).data("text")),d.font=$(this).data("font"),d.color=$(this).data("color"),d.gravity=$(this).data("gravity"),d.zindex=$(this).data("zindex");var e=$(this).find(".currenttext").data();d.x=e.left*f,d.y=e.top*g,d.dx=e.width*f,d.dy=e.height*g,a[b].texts.push(d)}),a[b].cliparts=new Array,$(this).find(".currentclipartholder").each(function(c){var d=new Object,e=$(this).find(".currentclipart").data();d.id=$(this).data("id"),d.x=e.left*f,d.y=e.top*f,d.dx=e.width*f,d.dy=e.height*g,d.zindex=$(this).data("zindex"),a[b].cliparts.push(d)}),b++}),$.ajax({type:"POST",url:"/create/newgift/save",dataType:"JSON",data:{pages:$.toJSON(a)},success:function(a){return document.location.href="/cart/accessories/",!1},complete:function(a){},error:function(a){alert("error")}})}var holdbutton=!1,Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b="",c,d,e,f,g,h,i,j=0;a=Base64._utf8_encode(a);while(j<a.length)c=a.charCodeAt(j++),d=a.charCodeAt(j++),e=a.charCodeAt(j++),f=c>>2,g=(c&3)<<4|d>>4,h=(d&15)<<2|e>>6,i=e&63,isNaN(d)?h=i=64:isNaN(e)&&(i=64),b=b+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h)+this._keyStr.charAt(i);return b},decode:function(a){var b="",c,d,e,f,g,h,i,j=0;a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(j<a.length)f=this._keyStr.indexOf(a.charAt(j++)),g=this._keyStr.indexOf(a.charAt(j++)),h=this._keyStr.indexOf(a.charAt(j++)),i=this._keyStr.indexOf(a.charAt(j++)),c=f<<2|g>>4,d=(g&15)<<4|h>>2,e=(h&3)<<6|i,b+=String.fromCharCode(c),h!=64&&(b+=String.fromCharCode(d)),i!=64&&(b+=String.fromCharCode(e));return b=Base64._utf8_decode(b),b},_utf8_encode:function(a){if(!a)return!0;a=a.replace(/\r\n/g,"\n");var b="";for(var c=0;c<a.length;c++){var d=a.charCodeAt(c);d<128?b+=String.fromCharCode(d):d>127&&d<2048?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(d&63|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(d&63|128))}return b},_utf8_decode:function(a){var b="",c=0,d=c1=c2=0;while(c<a.length)d=a.charCodeAt(c),d<128?(b+=String.fromCharCode(d),c++):d>191&&d<224?(c2=a.charCodeAt(c+1),b+=String.fromCharCode((d&31)<<6|c2&63),c+=2):(c2=a.charCodeAt(c+1),c3=a.charCodeAt(c+2),b+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63),c+=3);return b}}