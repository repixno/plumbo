(function(a){var b=function(b,c){function k(b){a("#imagelist").html(""),a.post("/api/1.0/tedit/loadimages",{albumid:b},function(b){a(b.data).each(function(b,c){a(".albumlist").hide();var d=a('<img class="image" style="z-index:1000"/>');d.attr({id:c.id,x:100,y:100}),d.attr("src",c.thumbnail),d.draggable({containment:"document",helper:"clone",cursor:"move"}),a("#imagelist").prepend(d)})},"json")}function l(a,b,c,d,e,f){var g=new Image;g.onload=function(){var a=new fabric.Newimage(this,{originX:"center",originY:"center",left:c,top:d,scaleX:e,scaleY:f});j.add(a),j.setActiveObject(a)},g.src=a}var d=a.extend({width:595,height:341,id:"c"},c||{}),e=this,f=0,g=new Array,h=new Array,i=new Array,j=new fabric.Canvas(d.id);this.canvas=j,this.changeBackground=function(a){src="/assets/producteditor/web/backgrounds/"+a,background=j.setBackgroundImage(src)},j.on("object:selected",function(a){console.log(a.target.type),a.target.type=="i-text"&&(a=a.target,e.changeText(a))}),j.on("selection:cleared",function(){a("#textedit").hide(),a("#imagemenu").hide()}),j.on("object:modified",function(){e.updateThumbs(),e.savehistory()}),a("#"+d.id).droppable({over:function(){console.log("ka i alle")},drop:function(b,c){var d=c.draggable[0].id,f=c.offset.left-a(this).offset().left,g=c.offset.top-a(this).offset().top,h=!1;for(var i=j._objects.length-1;i>0;i--){console.log(i);if(j._objects[i].type=="newimage"){var k=j._objects[i].left,m=j._objects[i].top,n=f+c.helper[0].width/2,o=g+c.helper[0].height/2,p=Math.max(k,n)-Math.min(k,n),q=Math.max(m,o)-Math.min(m,o),r=j._objects[i].currentWidth/2-p,s=j._objects[i].currentHeight/2-q;if(r>0&&s>0){console.log(c.helper[0].src),console.log(),j.renderAll(),e.changesrc("/images/stream/image/"+d,d),h=!0;break}}}h==0&&l("/images/stream/image/"+d,d,f,g,.5,.5)}}),this.undo=function(){g[f]>0&&(g[f]--,j.loadFromJSON(history[f][g[f]]),j.renderAll())},this.redo=function(){g[f]<history[f].length&&(console.log("redo  "),g[f]++,console.log(g),j.loadFromJSON(history[f][g[f]]),j.renderAll())},this.updateThumbs=function(){return h[f]=j.toDataURLWithMultiplier("jpg",.2,60),a(".preview-"+f+" img").attr("src",h[f]),!1},this.savehistory=function(){history[f]||(history[f]=new Array),g[f]||(g[f]=1),console.log(g[f]),j.toJSON()!=history[f][g[f]]&&(history[f][g[f]]=new Object,history[f][g[f]]=j.toJSON()),g[f]++},this.loadpage=function(b,c){i[f]=j.toJSON();if(f==c)return!1;f=c,j.clear();var d=900;return j.clear(),i[f]?j.loadFromJSON(i[f]):a.post("/api/1.0/tedit/loadpage",{malid:b,malpageid:c},function(b){var e=b.data,g=e.printwidth/d,h=e.printheight/g;e.content.length==0?(j.setWidth(d),j.setHeight(h),j.calcOffset()):(a("#wrap1").css("width",d),j.setWidth(d),j.setHeight(h),j.calcOffset(),j.loadFromJSON(e.content,j.renderAll.bind(j)),f=c)},"json"),!1},this.getUploaded=k,this.changeSelectedImage=function(a,b,c){var d=j.getActiveObject(),e=new Image;e.onload=function(){var a=d.width/2,b=d.width/2;d.setElement(e),d.clipTo=function(c){c.rect(-a,-b,e.width,e.height)},j.renderAll()},e.src=a},this.changeImageNew=function(a,b,c){var d=new Image,e=j.getActiveObject();d.onload=function(){var a=fabric.util.createCanvasElement(),b=d.width/d.height,c=e.width/e.height,f=0,g=0;console.log(b),console.log(c);if(b==c)var h=e.width,i=e.height;else if(b>c)var h=d.width,i=d.height;else{console.log(d.height);var h=d.width,i=d.width/c}console.log("imnagawwidth"+h),console.log("imageheigh"+i),a.width=h,a.height=i,a.getContext("2d").drawImage(d,0,0,h,i,0,0,h,i);var k=d;d.onload=function(){var b=e.width/a.width;e.setElement(this),e.set({scaleX:e.scaleX*b,scaleY:e.scaleY*b,top:e.top,left:e.left,angle:e.angle,_originalElement:k}),e.setCoords(),j.renderAll(),console.log(e)},d.src=a.toDataURL("image/jpg")},d.src=a},this.changesrc=function(a,b){var c=j.getActiveObject(),d=c.getElement();b!=null&&c.set({id:b}),console.log(c);var e=a,f=c.left,g=c.top,h=c.scaleX,i=c.scaleY;console.log(i),this.addnewimage(e,b,f,g,h,i),c.remove(),j.renderAll()},this.addnewimage=l,this.changeBackground=function(b){backgroundcat=a("#select_background").val(),src="/assets/producteditor/web/backgrounds/"+b,j.setBackgroundImage(src,j.renderAll.bind(j),{opacity:1})},this.zoomBy=function(a,b,c){var d=j.getActiveObject();d&&(d.crop.z&&(c=d.crop.z+c),d.crop.x&&(a=d.crop.x+a),d.crop.y&&(b=d.crop.y+b),d.crop={z:c,x:a,y:b},d.applyCrop(j.renderAll.bind(j)))},this.deleteImage=function(){j.getActiveObject().remove()},this.moveForward=function(){j.getActiveObject().bringForward()},this.moveBackward=function(){j.getActiveObject().sendBackwards()},this.addtext=function(a){var b=new fabric.IText(a,{left:100,top:100,id:"text",fill:"#000000"});j.add(b)},this.updateText=function(b){var c=a("#font-list").val(),d=a("#gravity").val(),e=a("#textweight").val();console.log(e),c!="Times New Roman"&&a("head").append('<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family='+c+'">');var f=j.getActiveObject(),g=a("#colorselect").val(),h=a("#colorselect").attr("data-opacity");f.set({text:b,fill:g,opacity:h,fontFamily:c,textAlign:d,fontWeight:e}),j.renderAll()},this.changeText=function(b){var c=b.text,d=b.fill,f=b.fontFamily,g=b.textAlign,h=b.fontWeight;a("#text").val(c),a("#colorselect").val(d),a("#font-list").val(f),a("#gravity").val(g),a("#textweight").val(h),a(".radio, .textweight").css("background-position-x","-7px"),a("#"+g).css("background-position-x","-37px"),a("#"+h).css("background-position-x","-37px"),a("#colorselect").minicolors("destroy"),a("#colorselect").minicolors({opacity:!0,change:function(b,c){console.log(b),e.updateText(a("#text").val())}}),a(".minicolors-swatch span").css("background-color",d),a("#tabs").tabs({active:4})}};a.fn.teditor=function(c){return this.each(function(){var d=a(this);if(d.data("teditor"))return;var e=new b(this,c);d.data("teditor",e)})}})(jQuery)