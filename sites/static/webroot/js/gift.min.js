function stretchToFit(){if($("#template").data("websize_x")&&$("#template").data("websize_y")){$("#template-wrapper").width($("#template").data("websize_x")),$("#template-wrapper").height($("#template").data("websize_y")),$("#template").width($("#template").data("websize_x")),$("#template").height($("#template").data("websize_y"));var a=parseFloat($("#template").data("websize_x")),b=parseFloat($("#template").data("websize_y"));if(a>b)var c=$("#template").data("fullsize_x")/630;else var c=$("#template").data("fullsize_y")/maxHeight;var d=parseFloat($("#template").data("fullsize_pos_x")/c),e=parseFloat($("#template").data("fullsize_pos_y")/c),f=parseFloat($("#template").data("fullsize_pos_dx")/c),g=parseFloat($("#template").data("fullsize_pos_dy")/c)}else{var a=parseFloat($("#original-template-width").val()),b=parseFloat($("#original-template-height").val());if(a>b)var c=$("#original-template-width").val()/630;else var c=$("#original-template-height").val()/maxHeight;var d=parseFloat($("#original-pos-x").val()/c),e=parseFloat($("#original-pos-y").val()/c),f=parseFloat($("#original-pos-dx").val()/c),g=parseFloat($("#original-pos-dy").val()/c)}if($("#template").height()>=maxHeight){if(!ie6){var h=$("#template").height()/maxHeight;$("#template").height(maxHeight),$("#template").width($("#template").width()/h),$("#template-wrapper").css("margin-left",parseFloat(630-$("#template").width())/2)}}else $("#template-wrapper").css("margin-left","0");var i=g,j=f;if($("#image").width()>=$("#image").height()){var k=f/g,l=$("#image").width()/$("#image").height();k>l?(i=parseFloat(f/l),e-=(i-g)/2):(j=parseFloat(g*l),d-=(j-f)/2)}else{var l=$("#image").height()/$("#image").width(),k=g/f;l>=k?(i=parseFloat(f*l),e-=(i-g)/2):(j=parseFloat(g/l),d-=(j-f)/2)}$("#image").width(j),$("#image").height(i),$("#image").css("left",d),$("#image").css("top",e),$("#helper").width(j).css("left",parseInt(d)),$("#helper").height(i).css("top",parseInt(e)),$("#template").width()&&$("#image").width()&&($("#helper").width(j),$("#helper").height(i),$("#template-wrapper").width($("#template").width()),$("#template-wrapper").height($("#template").height()),ie6&&$("#template").data("websize_x")&&$("#template").data("websize_y")&&($("#template-wrapper").width($("#template").data("websize_x")),$("#template-wrapper").height($("#template").data("websize_y"))))}function getImage(a){var b=400,c=630;return"/images/stream/image/"+a+"/"+c+"/"+b}function startZoomIn(){zoomTimer&&endZoom(),isZooming=!0,setTimeout("zoomIn()",20)}function startZoomOut(){zoomTimer&&endZoom(),isZooming=!0,setTimeout("zoomOut()",20)}function endZoom(){zoomTimer&&(clearTimeout(zoomTimer),zoomTimer=!1),isZooming=!1}function zoomIn(a){$("#image").width($("#image").width()+$("#image").width()/50),$("#image").height($("#image").height()+$("#image").height()/50),$("#helper").width($("#image").width()),$("#helper").height($("#image").height()),isZooming&&(zoomTimer&&(clearTimeout(zoomTimer),zoomTimer=!1),zoomTimer=setTimeout("zoomIn('#image')",20))}function zoomOut(a){$("#image").width($("#image").width()-$("#image").width()/50),$("#image").height($("#image").height()-$("#image").height()/50),$("#helper").width($("#image").width()),$("#helper").height($("#image").height()),isZooming&&(zoomTimer&&(clearTimeout(zoomTimer),zoomTimer=!1),zoomTimer=setTimeout("zoomOut('#image')",20))}function convertAlignToTaule(a){return a=="left"?"West":a=="center"?"Center":a=="right"?"East":"West"}function save(){var a=$("#original-template-width").val()/$("#template").width(),b=$("#original-template-height").val()/$("#template").height(),c=$("#image").position(),d=new Array;d.push(),d[0]=new Object,d[0].malid=$("#template").data("malid"),d[0].malpageid=$("#template").data("malpageid"),d[0].giftQuantity=$("#gift-quantity").val(),d[0].productoptionid=$("#productoptionid").val(),d[0].productid=$("#productid").val(),d[0].size="small",d[0].editor_x=$("#template-wrapper").width(),d[0].editor_y=$("#template-wrapper").height(),$("#red-eye").is(":checked")&&(d[0].redeye="true"),d[0].image=new Object,d[0].image.x=c.left*a,d[0].image.y=c.top*b,d[0].image.dx=$("#image").width()*a,d[0].image.dy=$("#image").height()*b,d[0].image.bid=$("#selected-image").val(),d[0].texts=new Array,$(".textholder").each(function(c){var e=$(this).position(),f=new Object;f.text=Base64.encode($(this).data("text")),f.font=$(this).data("font"),f.color=$(this).data("color"),f.gravity=$(this).data("gravity"),f.zindex=$(this).data("zindex"),f.x=e.left*a,f.y=e.top*b,f.dx=$(this).width()*a,f.dy=$(this).height()*b,d[0].texts.push(f)}),d[0].cliparts=new Array,$(".currentclipartholder").each(function(c){var e=$(this).position(),f=new Object;f.id=$(this).data("id"),f.x=e.left*a,f.y=e.top*a,f.dx=$(".currentclipart",this).width()*a,f.dy=$(".currentclipart",this).height()*b,f.zindex=$(this).data("zindex"),d[0].cliparts.push(f)}),$("input[name='name']").val()&&(d[0].name=$("input[name='name']").val(),d[0].font=$("input[name='font']:checked").val()),$.ajax({type:"POST",url:"/create/gift/save",dataType:"JSON",data:{pages:$.toJSON(d)},success:function(a){return document.location.href="/cart/accessories/",!1},complete:function(a){},error:function(a){alert("error")}})}$(document).ready(function(){$("#accordion").accordion({navigation:!0}),location.hash.toLowerCase().substring(1)=="choose-template"&&$("#accordion").accordion("activate",1),$.post("/api/1.0/prices/get",{productoptionid:1417,quantity:1},function(a){$("#redeye-price").text(a.price)},"json"),$(".quantity").bind("change",function(){var a=$(this).val();$.post("/api/1.0/prices/get",{productoptionid:productoptionid,quantity:a},function(a){$("#gift-price").text(a.price)},"json")});var a=1,b=210;$("#add-gift-to-cart").click(function(){save()}),ie6&&$("#template-wrapper").ready(function(){$("#template-wrapper").pngFix()}),$("#template-wrapper").load(function(){ie6&&$("#template-wrapper").pngFix()}),$("#template").data("malid",$("#initMalid").val()),$("#template").data("malpageid",$("#initMalpageid").val()),$("#select-album").bind("change",function(){$("#album-images").empty(),$("#album-images").append('<div class="loader center prepend-top"><img src="'+bigajaxLoader+'" title="loading" /></div>'),$.getJSON("/api/1.0/album/images/forpurchase/"+$(this).val(),function(a){a.result?($.each(a.images,function(a,b){$("#album-images").append('<img src="'+b.thumbnail+'" title="'+b.title+'" id="'+b.id+'"height="50" />')}),$(".loader","#album-images").remove()):($("#album-images").empty(),$("#album-images").append('<h3 class="prepend-top center">'+noImagesText+"</h3>"))})}),$(".text-align","#text-align").click(function(){$(this).hasClass("left")?$("#new-text").css("text-align","left"):$(this).hasClass("center")?$("#new-text").css("text-align","center"):$("#new-text").css("text-align","right")}),$(".template-thumb","#choose-template").live("click",function(){$("#template").remove(),$("#template-wrapper").prepend('<div id="template-ajax-loader"><img src="'+bigajaxLoaderGray+'"/></div>');var a=this,b=$(".mal",a).data("websize_x"),c=$(".mal",a).data("websize_y");$("#template-ajax-loader").css("opacity","0.8").css("margin","0").css("background-color","#666").css("padding-left",b/2).css("padding-top",c/2).css("z-index","34000").width("100%").height("100%");var d=new Image;return $(d).load(function(){$("#template-ajax-loader").remove(),$("#image-wrapper").before('<img id="template" src="" height="'+c+'" width="'+b+'" style="height:'+c+"px ; width:"+b+'px "/>'),$("#template").addClass("highrestemplate"),$("#template").attr("src",$(".highres",a).attr("href")),$("#template").data("malid",$(".malid",a).val()),$("#template").data("websize_x",b),$("#template").data("websize_y",c),$("#template").data("fullsize_pos_x",$(".mal",a).data("fullsize_pos_x")),$("#template").data("fullsize_pos_y",$(".mal",a).data("fullsize_pos_y")),$("#template").data("fullsize_pos_dx",$(".mal",a).data("fullsize_pos_dx")),$("#template").data("fullsize_pos_dy",$(".mal",a).data("fullsize_pos_dy")),$("#template").data("fullsize_x",$(".mal",a).data("fullsize_x")),$("#template").data("fullsize_y",$(".mal",a).data("fullsize_y")),$("#template").width(b),$("#template").height(c),$("#template").data("malid",$(".malid",a).val()),$("#template").data("malpageid",$(".malpageid",a).val()),$("#original-template-width").val($(".mal",a).data("fullsize_x")),$("#original-template-height").val($(".mal",a).data("fullsize_y")),ie6&&($(".highrestemplate").remove(),$("#template-wrapper").append('<img id="template" class="highrestemplate"/>'),$("#template").attr("src",$(".highres",a).attr("href")),$("#template-wrapper").pngFix(),$("#template").width(b),$("#template").height(c)),stretchToFit()}).attr("src",$(".highres",a).attr("href")),!1}),$("img","#album-images").live("click",function(){$("#template-wrapper").prepend('<div id="template-ajax-loader"><img src="'+bigajaxLoaderGray+'"/></div>'),$("#template-ajax-loader").css("opacity","0.8").css("margin","0").css("background-color","#666").css("padding-left",$("#template-wrapper").width()/2).css("padding-top",$("#template-wrapper").height()/2).css("z-index","34000").width("100%").height("100%"),$("#image").remove(),$("#image-wrapper").append('<img id="image" />');var a=new Image;$(a).load(function(){$("#template-ajax-loader").remove(),stretchToFit()}).attr("src",getImage($(this).attr("id"))),$("#image").attr("src",$(this).attr("src")),$("#selected-image").attr("value",$(this).attr("id")),$("#image").attr("src",getImage($(this).attr("id")));var b=this;$("#choose-template .template-thumb").css("background-image","url("+$(this).attr("src")+")"),$("#image").load(function(){stretchToFit()}),stretchToFit()}),$("img","#upload-queue").live("click",function(){var a=$(this).attr("id");$("#image").remove(),$("#image").attr("src",$(this).attr("src")),$("#selected-image").attr("value",a);var b=new Image;$(b).load(function(){$("#image-wrapper").append('<img id="image" />'),$("#image").attr("src",getImage(a)),$("#helper").width(b.width),$("#helper").height(b.height),stretchToFit()}).attr("src",getImage(a))}),$("#add-text").click(function(){$("#template-wrapper").prepend('<div id="textholder'+a+'" class="textholder"/>'),$("#textholder"+a).prepend('<img id="text'+a+'" class="currenttext"/>');var c=$("#new-text").val();if(c!=""){c=c.replace(/\n/g,"XXNYLINJEXX"),c=c.replace("&","XXOGXX"),c=c.replace(/\\/g,"\\\\"),c=c.replace(/\'/g,"\\'"),c=c.replace(/\"/g,'\\"'),c=c.replace(/\0/g,"\\0");var d=$("#new-text-color").val().replace("#",""),e=$("#fontselect").val(),f=convertAlignToTaule($("#new-text").css("text-align"));$("#text"+a).addClass("gifteditor_text");var g;ie6?g=0:g=1,$("#text"+a).attr("src","/api/1.0/gift/text/?id=0&quality=1&png="+g+"&font="+e+"&gravity="+f+"&color="+d+"&text="+c+"&encoding=UTF8");var h=$("#textholder"+a);$(".currenttext",h).width($("#template").width()/3),$(h).css({"z-index":"20"+a,position:"absolute",top:$("#template").height()/3,left:$("#template").width()/3}),$(h).prepend('<div class="attached_edit_box" id="edit_text_'+a+'"></div>'),$(h).data("font",e),$(h).data("gravity",f),$(h).data("color",d),$(h).data("text",c),$(h).data("zindex",b),$(".attached_edit_box",h).prepend('<div class="sliderContainer"><img src="http://static.repix.no/gfx/gui/gifteditor_smaller_text.png" class="smallertext" /><div class="slider"></div><img src="http://static.repix.no/gfx/gui/gifteditor_larger_text.png" class="largertext" /></div>');var i=$(h).position();$(h).mouseenter(function(){$(".attached_edit_box",h).fadeTo("fast",.8)}).mouseleave(function(){$(".attached_edit_box",h).fadeTo("fast",0)}),$(".attached_edit_box","#textholder"+a).append('<a href="#" class="delete button red x-small">'+deleteText+"</a>"),$("a.delete","#textholder"+a).click(function(){return $(h).remove(),!1}),$(h).draggable({containment:"#template-wrapper",handle:".currenttext"}),$(".slider",h).slider({value:$(".currenttext",h).width(),max:$("#template").width(),min:50,slide:function(a,b){$(".gifteditor_text",h).width(b.value)}}),$("#new-text").attr("value",""),a++,b++}}),$("#helper").width($("#image").width()),$("#helper").height($("#image").height()),$("#helper").draggable({drag:function(a,b){var c=$(this).position();$("#image").css({top:c.top,left:c.left,"margin-left":0,"margin-top":0})}}),$("#see-throug-template").click(function(){$(this).hasClass("clicked")?($("#template").fadeTo("slow",1),$(this).removeClass("clicked")):($("#template").fadeTo("slow",.7),$(this).addClass("clicked"))}),$("#zoom-in").bind("mousedown",function(){startZoomIn()}).bind("mouseup",function(){endZoom()}),$("#zoom-out").bind("mousedown",function(){startZoomOut()}).bind("mouseup",function(){endZoom()}),$("#clipartgroup-selector").bind("change",function(){var a=$(":selected",this).val();$("#clipart-selector .clipartcollection").hide(),$("#clipartcollection_id_"+a).css("display","block"),$("img","#clipartcollection_id_"+a).css("display","block"),$("#clipartcollection_id_"+a).show(),$("#clipart-selector .clipartcollection img").each(function(a,b){$(b).attr("src",$(b).attr("title"))})}),$(".clipartitem-container","#clipart-selector").live("click",function(){var a=$(this).attr("id").replace("clipartitem-container_","");$("#template-wrapper").prepend('<div id="clipartholder'+a+"-"+b+'" class="currentclipartholder"/>');var c=$("#clipartholder"+a+"-"+b);$(c).prepend('<img id="currentclipart'+a+"-"+b+'" class="currentclipart"/>'),$("img.currentclipart",c).attr("src",$("img",this).attr("src")),$(c).css({position:"absolute","z-index":b,top:50,left:50});var d=staticurl+"images/clipart/thumbs/width/300/"+a.toString()+".png";ie6&&(d="/clipart/"+a.toString()+"_thumb.gif",$("img.currentclipart",c).attr("src",d)),ie6||$("img.currentclipart",c).attr("src",d),$(".currentclipart",c).width(200),$(c).prepend('<div class="attached_edit_box" id="edit_clipart_'+a+'"></div>'),$(".attached_edit_box",c).prepend('<div class="sliderContainer"><img src="'+staticurl+'gfx/gui/gifteditor_smaller_text.png" class="smallertext" />'+'<div class="slider"></div>'+'<img src="'+staticurl+'gfx/gui/gifteditor_larger_text.png" class="largertext" />'+"</div>");var e=$(c).position();$(".slider",c).slider({value:$(c).width(),max:$("#template").width()-e.left,min:30,slide:function(a,b){$("img.currentclipart",c).width(b.value)}}),$(c).mouseenter(function(){$(".attached_edit_box",c).fadeTo("fast",.8)}).mouseleave(function(){$(".attached_edit_box",c).fadeTo("fast",0)}),$(".attached_edit_box",c).append('<a href="#" class="delete button red x-small">Delete</a>'),$("a.delete",c).click(function(){return $(c).remove(),!1}),$(c).draggable({handle:".currentclipart"}),$(c).data("id",a),$(c).data("zindex",b),b++}),$("#select-album").trigger("change")}),$(window).load(function(){stretchToFit()});var zoomTimer=!1,isZooming=!1,Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b="",c,d,e,f,g,h,i,j=0;a=Base64._utf8_encode(a);while(j<a.length)c=a.charCodeAt(j++),d=a.charCodeAt(j++),e=a.charCodeAt(j++),f=c>>2,g=(c&3)<<4|d>>4,h=(d&15)<<2|e>>6,i=e&63,isNaN(d)?h=i=64:isNaN(e)&&(i=64),b=b+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h)+this._keyStr.charAt(i);return b},decode:function(a){var b="",c,d,e,f,g,h,i,j=0;a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(j<a.length)f=this._keyStr.indexOf(a.charAt(j++)),g=this._keyStr.indexOf(a.charAt(j++)),h=this._keyStr.indexOf(a.charAt(j++)),i=this._keyStr.indexOf(a.charAt(j++)),c=f<<2|g>>4,d=(g&15)<<4|h>>2,e=(h&3)<<6|i,b+=String.fromCharCode(c),h!=64&&(b+=String.fromCharCode(d)),i!=64&&(b+=String.fromCharCode(e));return b=Base64._utf8_decode(b),b},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");var b="";for(var c=0;c<a.length;c++){var d=a.charCodeAt(c);d<128?b+=String.fromCharCode(d):d>127&&d<2048?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(d&63|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(d&63|128))}return b},_utf8_decode:function(a){var b="",c=0,d=c1=c2=0;while(c<a.length)d=a.charCodeAt(c),d<128?(b+=String.fromCharCode(d),c++):d>191&&d<224?(c2=a.charCodeAt(c+1),b+=String.fromCharCode((d&31)<<6|c2&63),c+=2):(c2=a.charCodeAt(c+1),c3=a.charCodeAt(c+2),b+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63),c+=3);return b}}