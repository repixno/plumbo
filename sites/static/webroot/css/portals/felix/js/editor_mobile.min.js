fabric.Object.prototype.originX=fabric.Object.prototype.originY="center";(function(b){var a=function(o,s){var M=b.extend({width:330,height:510,id:b(o).attr("id"),isMobile:false},s||{});var e=this;var i=new fabric.Canvas(M.id);var u,d,m;var l=null;var D=null;var x=null;this.canvas=i;var q=300;var K=250;var L=165;var r=7438;var A=false;var v="gul1.png";this.selectedtemplate=v;i.setHeight(510);i.setWidth(330);if(M.isMobile){i.setZoom(0.5);var k=254;var w=164;var f=237;var g=164;var h=270;var n=135}else{var k=510;var w=330;var f=474;var g=329;var h=535;var n=267}i.setHeight(k);i.setWidth(w);i.renderAll();i.setBackgroundImage("/felix/templates/background_gul1.png",i.renderAll.bind(i),{originX:"left",originY:"top"});b('input[name="size"]').on("change",function(){var N=b(this).val();b(".choosetemplate").hide();if(N=="1kg"){b(".btn-selected").removeClass("btn-selected");b(this).addClass("btn-selected");b("#1kg, .insp-1").show();e.changeTemplate("gul1.png","#ffb815","1")}else{if(N=="125kg"){b(".btn-selected").removeClass("btn-selected");b(this).addClass("btn-selected");b("#125kg, .insp-125").show();e.changeTemplate("gul125.png","#ffb815","125")}else{if(N=="05kg"){b(".btn-selected").removeClass("btn-selected");b(this).addClass("btn-selected");b("#05kg, .insp-05").show();e.changeTemplate("gul05.png","#ffb815","05")}}}});i.on("mouse:down",function(O){var Q=O.e.layerY;var P=182;var N=317;if(Q>P&&Q<N&&l){if(l.selectable){l.set({opacity:0.7});l.bringToFront();i.setActiveObject(l)}}else{if(l.active==true){l.set({opacity:1});l.sendBackwards();l.active=false}}});i.on("before:selection:cleared",I);b("#createown").on("click",function(){e.changeTemplate("gul1.png","#ffb815","1")});b(document).on("mouseout",".canvas-container",I);b("#sharefacebook").on("click",function(){y("Vänta, strax kommer du att kunna dela din etikett på Facebook…");shareThumb("facebook");return false});b(document).on("click",".shareonfacebook",function(){J()});b(document).on("click","#download",function(){y("Vänta, strax kommer du att kunna ladda ned din etikett...");var P=i.getActiveObject();if(P){P.active=false;i.renderAll()}var N=i.toDataURL();var O="felix";b.post("/api/1.0/felix/felixthumb",{name:O,image:N},function(Q){E("/skapa/download/"+Q.data+"/felix.jpg")},"json");return false});b("#skapa").on("click",function(){B()});b(".felixtext").on("change",function(Q){A=true;var O=b(this).val().split("\n");var P="";for(var N=0;N<O.length;N++){if(N<5){if(N+1==O.length||N==3){P+=O[N]}else{P+=O[N]+"\n"}}}b(this).val(P);e.updateText(P)});b(".zoom").bind("touchstart",function(){zoomingtimer=true;C(b(this).attr("id"));return false}).mousedown(function(){zoomingtimer=true;C(b(this).attr("id"));return false}).bind("touchend",F).mouseup(F).mouseleave(F);b(".move").bind("touchstart",function(){zoomingtimer=true;G(b(this).attr("id"));return false}).mousedown(function(){zoomingtimer=true;G(b(this).attr("id"));return false}).bind("touchend",F).mouseup(F).mouseleave(F);b(".rotate").bind("touchstart",function(){zoomingtimer=false;c(b(this).attr("id"));return false}).mousedown(function(){zoomingtimer=true;c(b(this).attr("id"));return false}).bind("touchend",F).mouseup(F).mouseleave(F);b(".removeclipart").on("click",function(){z()});b(".choosetemplate img").on("click",function(){e.changeTemplate(b(this).data("src"),b(this).data("color"),b(this).data("size"))});b(document).on("click",".item img",function(){e.changeTemplate(b(this).data("src"),"#fff","1")});b(".insp").on("click",function(){H(b(this).data("src"),b(this).data("color"),b(this).data("size"))});b("#next-template").on("click",function(){b("#next-template").hide();if(e.selectedtemplate=="FELI0076_Felix_ketchup_ekologisk_1kg_mk-7 kopi.jpg"){var N=b('a[data-src="gul1.png"]')}else{if(e.selectedtemplate=="FELP0076_Felix-ketchup_1,25kg_ORIGINAL_SVENSKT_ok-7 kopi.jpg"){var N=b('a[data-src="gul125.png"]')}else{if(e.selectedtemplate=="FELI0076_Felix_ketchup_ekologisk_500g_mk-6.jpg"){var N=b('a[data-src="gul05.png"]')}else{var N=b('a[data-src="'+e.selectedtemplate+'"]').next()}}}if(N.hasClass("insp")){H(N.data("src"),N.data("color"),N.data("size"))}else{e.changeTemplate(N.data("src"),N.data("color"),N.data("size"))}});b("#prev-template").on("click",function(){b("#prev-template").hide();if(e.selectedtemplate=="gul1.png"){var N=b('a[data-src="FELI0076_Felix_ketchup_ekologisk_1kg_mk-7 kopi.jpg"]')}else{if(e.selectedtemplate=="gul125.png"){var N=b('a[data-src="FELP0076_Felix-ketchup_1,25kg_ORIGINAL_SVENSKT_ok-7 kopi.jpg"]')}else{if(e.selectedtemplate=="gul05.png"){var N=b('a[data-src="FELI0076_Felix_ketchup_ekologisk_500g_mk-6.jpg"]')}else{var N=b('a[data-src="'+e.selectedtemplate+'"]').prev()}}}if(N.hasClass("insp")){H(N.data("src"),N.data("color"),N.data("size"))}else{e.changeTemplate(N.data("src"),N.data("color"),N.data("size"))}});b('a[data-toggle="tab"]').on("shown.bs.tab",function(N){if(b(N.target).attr("aria-controls")=="home"){if(l.id=="userimage"){b(".functionsbuttonsmobile").show()}}else{b(".functionsbuttonsmobile").hide()}});function E(O){var N=navigator.userAgent;var P=N.toLowerCase().match(/(iphone|ipod|ipad)/);if(P){b(".loadingInfo").find("h3").text("Etiketten är redo att laddas ner");b(".loadingInfo").find("p").html('<a class="btn btn-default shareonfacebook" href="'+O+'" target="_blank" >Öppna i ett nytt fönster för att ladda ner</a>')}else{if(d){d.attr("src",O)}else{d=b("<iframe/>",{id:"idown",src:O}).hide().appendTo("body")}J()}}function H(Q,O,P){predef=true;e.selectedtemplate=Q;if(l){l.remove()}if(x){x.remove()}if(P==1){r=7438;i.setHeight(510);i.setWidth(330);i.renderAll()}else{if(P==5){r=7554;i.setHeight(474);i.setWidth(330);i.renderAll()}else{r=7441;i.setHeight(535);i.setWidth(267);i.renderAll()}}var N=new Image();b(N).load(function(){b(".canvas-container").css("background",O);D.setElement(N);L=i.width/2;D.set({left:L,top:i.height/2,selectable:false,});if(u){u.set({left:L})}if(l){l.set({left:L})}p(O);if(P==1){i.setHeight(k);i.setWidth(w)}else{if(P==5){i.setHeight(f);i.setWidth(g)}else{i.setHeight(h);i.setWidth(n)}}i.renderAll();b("#next-template").show();b("#prev-template").show()});N.src="/felix/templates/web/"+Q}function B(){var P=new Object();if(l){P={imagetype:l.id,imageid:m,top:l.top,left:l.left,width:l.width,height:l.height,scaleX:l.scaleX,scaleY:l.scaleY,src:l._element.src,angle:l.angle}}var N=new Object({textimage:{top:x.top,left:x.left,width:x.width,height:x.height,text:b(".felixtext").val()},canvasimage:P,templateimage:{top:D.top,left:D.left,width:D.width,height:D.height,scaleX:D.scaleX,scaleY:D.scaleY,src:D._element.src}});var Q=JSON.stringify(N);Q=encodeURIComponent(Q);var O=i.toDataURLWithMultiplier("jpeg",0.5,90);b.post("/api/1.0/felix/save",{canvas:Q,thumb:O,productid:r},function(R){if(R.message=="OK"){window.location.href="/bekrafta/"+R.felixid}else{alert("noe gjekk gale")}},"json")}function t(){var O=JSON.stringify(i);O=encodeURIComponent(O);var N=i.toDataURLWithMultiplier("jpeg",0.4,90);b.post("/api/1.0/felix/inspirasjon",{canvas:O,thumb:N,productid:r},function(P){if(P.message=="OK"){}else{alert("noe gjekk gale")}},"json")}function F(){zoomingtimer=false}this.newzoom=C();function C(O){if(l){var P=l.scaleX;if(P==null){P=1}var N=P/100;if(N<0){N=-N}if(O=="zooml"){l.scale(P+N).setCoords();if(zoomingtimer){setTimeout(function(){C("zooml")},20)}}else{if(O=="zooms"){l.scale(P-N).setCoords();if(zoomingtimer){setTimeout(function(){C("zooms")},20)}}}i.renderAll()}}function G(Q){I();if(l){var P=i.getActiveObject();if(!P){P=l}var O=P.left;var N=P.top;if(P.id!="preimage"){if(Q=="up"){N=N-1;if(zoomingtimer){setTimeout(function(){G("up")},20)}}else{if(Q=="left"){O=O-1;if(zoomingtimer){setTimeout(function(){G("left")},20)}}else{if(Q=="right"){O=O+1;if(zoomingtimer){setTimeout(function(){G("right")},20)}}else{if(Q=="down"){N=N+1;if(zoomingtimer){setTimeout(function(){G("down")},20)}}}}}}P.set({top:N,left:O});i.renderAll()}}function c(O){I();if(l){if(O=="rotateright"){var N=l.angle+90}else{var N=l.angle-90}if(N>=360){N=360-N}l.set({angle:N});i.renderAll()}}function I(){if(l){if(l.active==true){l.set({opacity:1});l.sendToBack();l.active=false;i.renderAll()}}}this.setTemplate=function(){var N="/felix/templates/gul1.png";fabric.Image.fromURL(N,function(O){D=O.set({left:330/2,top:510/2,selectable:false,});i.add(O);O.sendToBack()})};function p(N){i.setBackgroundColor(N,i.renderAll.bind(i))}this.changeTemplate=function(Q,O,P){predef=false;this.selectedtemplate=Q;if(P==1){r=7438;i.setHeight(510);i.setWidth(330)}else{if(P=="05"){r=7554;i.setHeight(474);i.setWidth(330)}else{r=7441;i.setHeight(535);i.setWidth(267)}}if(l){if(P==1){q=365;K=100}else{if(P==5){q=340;K=90}else{q=385;K=140}}}else{K=250}var N=new Image();b(N).load(function(){b("#next-template").show();b("#prev-template").show();D.setElement(N);L=i.width/2;D.set({left:L,top:i.height/2,selectable:false});x.set({left:L,selectable:false});if(x&&l){x.set({height:K})}if(l){l.set({left:L})}i.setBackgroundImage("/felix/templates/background_"+Q,i.renderAll.bind(i),{originX:"left",originY:"top"});if(P==1){i.setHeight(k);i.setWidth(w)}else{if(P==5){i.setHeight(f);i.setWidth(g)}else{i.setHeight(h);i.setWidth(n)}}i.renderAll()});N.src="/felix/templates/"+Q};this.addText=function(){var N="/skapa/text?text="+encodeURIComponent(" ")+"&height="+K;fabric.Image.fromURL(N,function(O){x=O.set({left:L,top:270,id:"textimage",selectable:false,});i.add(x)});i.renderAll()};this.updateText=function(){A=true;var O=b(".felixtext").val();var N="/skapa/text?text="+encodeURIComponent(O)+"&height="+K;b(i._objects).each(function(){if(this.id=="textimage"){this.remove()}});x.remove();fabric.Image.fromURL(N,function(P){x=P.set({left:L,top:q,id:"textimage",selectable:false,});i.add(x);A=false});i.renderAll()};function z(){q=300;K=250;e.updateText();l.remove();l=null;i.renderAll()}this.updateImage=function(R,Q){if(A){return false}var P=246;var O=135;if(Q=="load"){var N=false;m=R.split("/").reverse()[0];Q="clipart"}else{if(Q=="clipart"){b(".functionsbuttonsmobile").hide();R="/felix/clipart/"+R+".png";m=R.split("/").reverse()[0];var N=false}else{b(".functionsbuttonsmobile").show();Q="userimage";var N=false;m=R;R="/skapa/stream/"+R+"/400/400"}}if(l){i.remove(l)}else{if(r==7438){K=100;q=365}else{if(r==7554){q=340;K=90}else{K=140;q=385}}e.updateText()}fabric.Image.fromURL(R,function(S){if(Q!="clipart"){if(S.width>S.height){var T=P/S.width}else{var T=O/S.height}}l=S.set({left:L,top:250,scaleX:T,scaleY:T,selectable:N,id:Q});i.add(S);if(Q=="clipart"){S.bringToFront()}else{S.sendToBack()}});i.renderAll();return true};function y(N){b("body").prepend('<div id="loader-overlay"><div class="loadingInfo"><p><img src="http://a.static.repix.no/gfx/gui/ajax-loader-gray.gif" /></p>									<br/><br/><h3>'+N+'<span id="status"></span></h3></div></div>');b("#loader-overlay").css("opacity","0.8").css("margin","0").width(b(window).width()).height(b(document).height());return false}function J(){b("#loader-overlay").fadeOut("slow",function(){b(this).remove()})}shareThumb=function(P){var N=i.toDataURLWithMultiplier("jpeg",1,90);var O="";if(P=="facebook"){O="https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent("http://felixbeta.eurofoto.se/skapa/ShareFacebook/")}b.post("/api/1.0/felix/felixthumb",{image:N},function(Q){var R="http://felixbeta.eurofoto.se/skapa/ShareFacebook/"+Q.data;j(R)},"json")};function j(N){sharelink="https://www.facebook.com/sharer/sharer.php?u=";b.post("https://graph.facebook.com",{id:N,scrape:true},function(O){setTimeout(function(){var P=navigator.userAgent;var Q=P.toLowerCase().match(/(iphone|ipod|ipad)/);if(Q){b(".loadingInfo").find("h3").text("Etiketten är redo att delas.");b(".loadingInfo").find("p").html('<a class="btn btn-default shareonfacebook" href="'+sharelink+N+'" target="_blank" >Klicka här för att dela din etikett</a>')}else{window.open(sharelink+N,"popupWindow","width=600,height=600,scrollbars=no");J()}},2500)})}};b.fn.FelixEditor=function(c){return this.each(function(){var d=b(this);if(d.data("FelixEditor")){return}var e=new a(this,c);d.data("FelixEditor",e)})}})(jQuery);function wrapText(e,b){var a=[];var d=e.split(/\b/);var f="";var c="";d.forEach(function(j){var i=f;f+=c+j;var h=f.length;if(h>b){a.push(i.trim());f=j;c=""}else{var g=f.match(/(.*)(\s+)$/);c=(g&&g.length===3&&g[2])||"";f=(g&&g.length===3&&g[1])||f}});if(f){a.push(f.trim())}return a.join("\n")};