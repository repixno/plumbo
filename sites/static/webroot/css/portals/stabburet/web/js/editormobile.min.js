function donedit(){1==userimg.active&&(userimg.set({opacity:1}),userimg.sendToBack(),userimg.active=!1,canvas.renderAll())}function stopzoom(){zoomingtimer=!1}function newzoom(a){var b=userimg.scaleX;null==b&&(b=1);var c=b/100;c<0&&(c=-c),"zooml"==a?(userimg.scale(b+c).setCoords(),zoomingtimer&&setTimeout('newzoom("zooml")',20)):"zooms"==a&&(userimg.scale(b-c).setCoords(),zoomingtimer&&setTimeout('newzoom("zooms")',20)),userimg instanceof Object==1&&$(".zoomlayer-out").css({top:userimg.top-userimg.height*userimg.scaleX/2+18,left:userimg.left-userimg.width*userimg.scaleX/2,width:userimg.width*userimg.scaleX,height:userimg.height*userimg.scaleY}),canvas.renderAll()}function movenew(a){donedit();var b=canvas.getActiveObject();b||(b=userimg);var c=b.left,d=b.top;"preimage"!=b.id&&("up"==a?(d-=1,zoomingtimer&&setTimeout('movenew("up")',20)):"left"==a?(c-=1,zoomingtimer&&setTimeout('movenew("left")',20)):"right"==a?(c+=1,zoomingtimer&&setTimeout('movenew("right")',20)):"down"==a&&(d+=1,zoomingtimer&&setTimeout('movenew("down")',20))),b.set({top:d,left:c}),canvas.renderAll()}function newrotate(a){if(donedit(),"rotateright"==a){var b=userimg.angle+1;zoomingtimer&&setTimeout('newrotate("rotateright")',20)}else{var b=userimg.angle-1;zoomingtimer&&setTimeout('newrotate("rotateleft")',20)}b>=360&&(b=360-b),userimg.set({angle:b}),canvas.renderAll()}function ChangeImageSrc(a){canvas.remove(userimg);var c=($(this).attr("src"),"/images/stream/image/"+a+"/400/400");fabric.Image.fromURL(c,function(b){userimg=b.set({left:220,top:220,lockUniScaling:!0,id:a}),canvas.add(b),userimg.sendToBack()})}function positionBtn(a){$("#deletebutton").show();var b=$("#c").offset();$("#deletebutton").css({top:a.top+b.top-a.currentHeight/2-30+"px",left:a.left+b.left+a.currentWidth/2+15+"px"})}function drawTextAlongArc(){for(var a="",b=new Object,c=0,d=textgroup.getObjects(),e=d.length;e>0;){d=textgroup.getObjects(),e=d.length;for(var f=0;f<e;f++)textgroup.remove(d[f])}var g=$("#name").val();g.length<1&&(g="LEVERPOSTEI");var h=g.length,j=0,k=-140;s=Math.PI*(h/12);for(var l=0,m=0;m<h;m++)b[m]=new fabric.Text(g[m].toUpperCase(),{fontSize:55,fontFamily:"FairplexWideOT-Med",fill:"#ffffff",textAlign:"center"}),l+=b[m].width+8;k=-(l/3.17),k<-140&&(k=-140),l=0;for(var m=0;m<h;m++){var n=150,o=218;k+=j;var q=n*n-k*k;q=Math.sqrt(q);var r=k/n;r=Math.acos(r)*(180/Math.PI)-90,text[m]=new fabric.Text(g[m].toUpperCase(),{fontSize:55,fontFamily:"FairplexWideOT-Med",fill:"#ffffff",textAlign:"center"}),l+=text[m].width+10,namelength=l,text[m].set({left:k+o,top:q+o,angle:r});var s=text[m].angle,t=s;s<5&&(s=-s+text[m].width/2),h>m+1&&(a=new fabric.Text(g[m+1].toUpperCase(),{fontSize:55,fontFamily:"FairplexWideOT-Med",angle:r,fill:"#ffffff",textAlign:"center"})),c=t<10?1:3;var u=(text[m].width/2+c)*Math.cos(r/(180/Math.PI)),v=(a.width/2+c)*Math.cos(s/(180/Math.PI));r<-60?$("#name").attr("maxlength",h):$("#name").attr("maxlength",111),j=v+u,textgroup.add(text[m])}return canvas.add(textgroup),canvas.renderAll(),textgroup.bringToFront(),!1}function drawYearAlongArc(){for(var a=yeargroup.getObjects(),b=a.length;b>0;){a=yeargroup.getObjects(),b=a.length;for(var c=0;c<b;c++)yeargroup.remove(a[c])}var d=$("#year").val();d=d.length<1?"ORIGINALEN SIDEN 1949":"ORIGINALEN SIDEN "+d;var e=d.length,g=90,h=-118;h=h,angle=Math.PI*(e/12);for(var i=0;i<e;i++){var j=189,k=218;angle/e*100;g=17,h+=g/1.6;var m=j*j-h*h;m=Math.sqrt(m);var n=h/j;n=Math.acos(n)*(180/Math.PI)-90,g=Math.round(n),text[i]=new fabric.Text(d[i].toUpperCase(),{left:h+k,top:m+k,fontSize:20,fontFamily:"FairplexWideOT-Med",angle:n,fill:"#e3202d"}),yeargroup.add(text[i])}return canvas.add(yeargroup),canvas.renderAll(),yeargroup.bringToFront(),!1}function shareThumb(a){var b=canvas.toDataURL({format:"png"}),c="";"facebook"==a&&(c="https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent("http://stabburetbeta.eurofoto.no/bestill/ShareFacebook/")),$.post("/api/1.0/stabburet/savethumb",{thumb:b},function(a){var b="http://stabburetbeta.eurofoto.no/bestill/ShareFacebook/"+a.data;onResultPageGenerated(b)},"json")}function onResultPageGenerated(a){console.log(a),sharelink="https://www.facebook.com/sharer/sharer.php?u=",$.post("https://graph.facebook.com",{id:a,scrape:!0},function(b){setTimeout(function(){$(".loadingInfo").html('<div><h3>Lokket er nå klart til å kunne deles</h3></div><div><a class="btn large" href="'+sharelink+a+'" onclick="window.open(this.href, \'mywin\', \'left=20,top=20,width=500,height=500,toolbar=1,resizable=0\'); hideloader(); return false;" >\t\t\t\t\t\t\t\t\t\t   <span><img src="http://static.repix.no/cms/images/del-facebook-2.jpg"/></span> Del lokket</a></div>')},500)})}function quickHideAddressBar(){setTimeout(function(){0===window.pageYOffset&&window.scrollTo(0,window.pageYOffset+1)},1e3)}function showloader(){return $("body").prepend('<div class="loadercontainer"><div class="loadingInfo"><img src="http://a.static.repix.no/gfx/gui/ajax-loader-gray.gif" />                                <br/><br/><h3>Loading.......<span id="status"></span></h3></div><div id="loader-overlay"></div></div>'),$(".loadercontainer").width($(window).width()).height($(document).height()),$(".loadingInfo").width($(window).width()).height($(document).height()),$("#loader-overlay").css("opacity","0.8").css("margin","0").width($(window).width()).height($(document).height()),!1}function hideloader(){$(".loadercontainer").fadeOut("slow",function(){$(this).remove()})}function downloadURL(a){$(".loadingInfo").html('<div><h3>Lokket er nå klart til å kunne lastes ned</h3></div><div><a class="btn large" href="'+a+'" target="_blank" onclick="hideloader();" >\t\t\t\t\t\t\t\t\t\t   Last ned lokket</a></div>')}function upenurl(a){return window.open(a,"_blank","toolbar=yes, scrollbars=yes, resizable=yes, top=500, left=500, width=400, height=400"),!1}function isCanvasSupported(){var a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))}fabric.Object.prototype.originX=fabric.Object.prototype.originY="center";var canvas=null,userimg,template,rotateval,zoomval,namelength,zoomingtimer=!1,text=new Array,textgroup=new fabric.Group,yeargroup=new fabric.Group;$(function(){isCanvasSupported()||$(".editorbox").append('Editoren støttes dessverre ikke av din nettleser. Du kan laste ned en gratis nettleser, vi anbefaler Google Chrome.<br/>\t\t\tLast ned her <a href="http://www.google.com/intl/no/chrome/browser/" target="blank">http://www.google.com/intl/no/chrome/browser/</a>'),canvas=new fabric.Canvas("c"),$("#file").click(function(){return fileInput.click(),!1}).show(),$(document).on("click",".disabled",function(){return!1}),$(document).on("click","#imageval",function(){return $(".imageval").show(),$(".textval").hide(),!1}),$(document).on("click","#textval",function(){return $(".imageval").hide(),$(".textval").show(),!1}),$(document).on("mouseout",".canvas-container",donedit),$("#deletebutton").hide(),$(document).on("click",".clipart",function(){addClipart($(this).attr("id"))}),canvas.findTarget=function(a){return function(){var b=a.apply(this,arguments);return b?this._hoveredTarget!==b&&(canvas.fire("object:over",{target:b}),this._hoveredTarget&&canvas.fire("object:out",{target:this._hoveredTarget}),this._hoveredTarget=b):this._hoveredTarget&&(canvas.fire("object:out",{target:this._hoveredTarget}),this._hoveredTarget=null),b}}(canvas.findTarget),canvas.on("object:over",function(a){activeclipart=a,"clipart"==a.target.id?selectclipart=!0:selectclipart=!1}),canvas.on("object:out",function(a){activeclipart.target.top==a.target.top&&"clipart"==a.target.id&&(selectclipart=!1)}),$("#imageupload").change(function(){$(".imagethumb").css("border-color","#fff"),$(this).upload("/api/1.0/tedit/upload",function(a){var b='<img class="imagethumb" id="'+a.name+'"src="/tedit/thumbs/'+a.name+'"  />';$("#imagelist").append(b),ChangeImageSrc(a.name),$("img#"+a.name).css("border-color","#0199d8")},"json")}),$(document).on("click",".imagethumb",function(){$(".imagethumb").css("border-color","#fff"),$(this).css("border-color","#0199d8"),ChangeImageSrc($(this).attr("id"))}),fabric.Image.fromURL(malimage,function(a){template=a.set({left:219.5,top:219.5,selectable:!1}),canvas.add(a)}),fabric.Image.fromURL(blankimage,function(a){userimg=a.set({left:220,top:220,id:"preimage",lockUniScaling:!0,selectable:!1,textShadow:"rgba(0,0,0,0.2) 0 0 5px"}),canvas.add(a),userimg.sendBackwards()}),canvas.on("touch:drag",function(a){if(userimg.active)return!0;var b=a.e.layerX,c=a.e.layerY,d=220,e=110;(b-d)*(b-d)+(c-d)*(c-d)<e*e&&("preimage"==userimg.id?$("#velgbilde").click():(userimg.set({opacity:.7}),userimg.bringToFront(),canvas.setActiveObject(userimg)))}),canvas.on("before:selection:cleared",function(a){1==userimg.active&&(userimg.set({opacity:1}),userimg.sendToBack())}),$("#editimage").on("click",function(){userimg.set({opacity:.7}),userimg.bringForward(),canvas.setActiveObject(userimg)});var a;$(document).on("touchend",function(b){var c;c=(new Date).getTime();var d=c-a;d<500&&b.preventDefault(),a=c}),$(document).on("click","#doneedit",donedit),$(".zoom").bind("touchstart",function(){return zoomingtimer=!0,newzoom($(this).attr("id")),!1}).mousedown(function(){return zoomingtimer=!0,newzoom($(this).attr("id")),!1}).bind("touchend",stopzoom).mouseup(stopzoom).mouseleave(stopzoom),$(".move").bind("touchstart",function(){return zoomingtimer=!0,movenew($(this).attr("id")),!1}).mousedown(function(){return zoomingtimer=!0,movenew($(this).attr("id")),!1}).bind("touchend",stopzoom).mouseup(stopzoom).mouseleave(stopzoom),$(".rotate").bind("touchstart",function(){return zoomingtimer=!0,newrotate($(this).attr("id")),!1}).mousedown(function(){return zoomingtimer=!0,newrotate($(this).attr("id")),!1}).bind("touchend",stopzoom).mouseup(stopzoom).mouseleave(stopzoom),$("#name").keyup(drawTextAlongArc),$("#name").focus(function(){"LEVERPOSTEI"==$(this).val()&&$(this).val("")}),$("#year").focus(function(){"1949"==$(this).val()&&$(this).val("")}),$(document).on("change","#year",drawYearAlongArc),$(document).on("click","#year",function(){return!1}),$(document).on("click","#download",function(){showloader();var a=canvas.getActiveObject();a&&(a.active=!1,canvas.renderAll());var b=canvas.toDataURL(),c="stabburet";return $.post("/api/1.0/stabburet/stabburetthumb",{name:c,image:b},function(a){downloadURL("/bestill/download/"+a.data+"/leverposteilokk.png")},"json"),!1}),$(document).on("click","#share",function(){var a=canvas.getActiveObject();a&&(a.active=!1,canvas.renderAll());var b=canvas.toDataURL(),c="stabburet";$.post("/api/1.0/tedit/stabburetthumb",{name:c,image:b},function(a){$("#sharewindow").dialog({width:640,height:600,title:"Del ditt leverposteilokk",open:function(a,b){$(".ui-dialog-content").css({overflow:"hidden"})},beforeClose:function(a,b){$(".ui-dialog-content").css({overflow:"auto"})}}),$("#sharewindow iframe").attr("src","/stabburet/share/"+a.data)},"json")}),$(".bestillknapp").on("click",save)}),$(window).on("load",function(){drawTextAlongArc(),drawYearAlongArc(),setTimeout(function(){canvas.renderAll()},150)}),this.save=function(a,b){if("preimage"==userimg.id)return!1;showloader(),userimg.set({opacity:1}),userimg.sendToBack(),userimg.active=!1;var c=canvas.getObjects(),e=(c[0]._element,c[0].width*c[0].scaleX),f=c[0].height*c[0].scaleY,g=JSON.stringify("["+c[0].left+","+c[0].top+","+e+","+f+","+c[0].angle+"]"),h=$("#c").height(),b=$("#name").val(),i=$("#year").val(),j=canvas.toDataURLWithMultiplier("jpeg",.8,90),k="small",l=c[0].id;return $.post("/api/1.0/stabburet/save",{name:b,year:i,imageid:l,imgpos:g,thumb:j,malsize:h,lokksize:k},function(a){window.location.href="/lag-lokk/checkout/bestilling"},"json"),!1};