function setup(){canvas=new fabric.Canvas("c"),$("#file").click(function(){return fileInput.click(),!1}).show(),$(document).on("click",".disabled",function(){return!1}),$(document).on("click","#imageval",function(){return $(".imageval").show(),$(".textval").hide(),!1}),$(document).on("mouseout",".canvas-container",donedit),canvas.findTarget=function(a){return function(){var b=a.apply(this,arguments);return b?this._hoveredTarget!==b&&(canvas.fire("object:over",{target:b}),this._hoveredTarget&&canvas.fire("object:out",{target:this._hoveredTarget}),this._hoveredTarget=b):this._hoveredTarget&&(canvas.fire("object:out",{target:this._hoveredTarget}),this._hoveredTarget=null),b}}(canvas.findTarget),$("#imageupload").change(function(){$(".imagethumb").css("border-color","#fff"),$(this).upload("/api/1.0/tedit/upload",function(a){var b='<img class="imagethumb" id="'+a.name+'"src="/tedit/thumbs/'+a.name+'"  />';$("#imagelist").append(b),ChangeImageSrc(a.name),$("img#"+a.name).css("border-color","#0199d8")},"json")}),$(document).on("click",".imagethumb",function(){$(".imagethumb").css("border-color","#fff"),$(this).css("border-color","#0199d8"),ChangeImageSrc($(this).attr("id"))}),fabric.Image.fromURL(malimage,function(a){template=a.set({left:219.5,top:219.5,selectable:!1,id:"mal"}),canvas.add(a)}),canvas.on("mouse:down",function(a){var b=a.e.layerX,c=a.e.layerY,d=220,e=110;(b-d)*(b-d)+(c-d)*(c-d)<e*e&&(userimg.id=="preimage"?$("#imageupload").click():(userimg.set({opacity:.7}),userimg.bringToFront(),canvas.setActiveObject(userimg)))}),canvas.on("before:selection:cleared",function(a){userimg.active==1&&(userimg.set({opacity:1}),userimg.sendToBack())}),$("#editimage").on("click",function(){userimg.set({opacity:.7}),userimg.bringForward(),canvas.setActiveObject(userimg)}),$(document).on("click","#doneedit",donedit),$(document).on("click","#download",function(){showloader();var a=canvas.getActiveObject();a&&(a.active=!1,canvas.renderAll());var b=canvas.toDataURL(),c="stabburet";return $.post("/api/1.0/stabburet/stabburetthumb",{name:c,image:b},function(a){downloadURL("/bestill/thumb/"+a.data+"/leverposteilokk.png")},"json"),!1}),$(document).on("click","#share",function(){var a=canvas.getActiveObject();a&&(a.active=!1,canvas.renderAll());var b=canvas.toDataURL(),c="stabburet";$.post("/api/1.0/tedit/stabburetthumb",{name:c,image:b},function(a){$("#sharewindow").dialog({width:640,height:600,title:"Del ditt leverposteilokk",open:function(a,b){$(".ui-dialog-content").css({overflow:"hidden"})},beforeClose:function(a,b){$(".ui-dialog-content").css({overflow:"auto"})}}),$("#sharewindow iframe").attr("src","/stabburet/share/"+a.data)},"json")}),$(".bestillknapp").on("click",save)}function donedit(){userimg&&userimg.active==1&&(userimg.set({opacity:1}),userimg.sendToBack(),userimg.active=!1,canvas.renderAll())}function stopzoom(){zoomingtimer=!1}function newzoom(a){var b=userimg.scaleX;b==null&&(b=1);var c=b/100;c<0&&(c=-c),a=="zooml"?(userimg.scale(b+c).setCoords(),zoomingtimer&&setTimeout('newzoom("zooml")',20)):a=="zooms"&&(userimg.scale(b-c).setCoords(),zoomingtimer&&setTimeout('newzoom("zooms")',20)),userimg instanceof Object==1&&$(".zoomlayer-out").css({top:userimg.top-userimg.height*userimg.scaleX/2+18,left:userimg.left-userimg.width*userimg.scaleX/2,width:userimg.width*userimg.scaleX,height:userimg.height*userimg.scaleY}),canvas.renderAll()}function movenew(a){donedit();var b=canvas.getActiveObject();b||(b=userimg);var c=b.left,d=b.top;b.id!="preimage"&&(a=="up"?(d-=1,zoomingtimer&&setTimeout('movenew("up")',20)):a=="left"?(c-=1,zoomingtimer&&setTimeout('movenew("left")',20)):a=="right"?(c+=1,zoomingtimer&&setTimeout('movenew("right")',20)):a=="down"&&(d+=1,zoomingtimer&&setTimeout('movenew("down")',20))),b.set({top:d,left:c}),canvas.renderAll()}function newrotate(a){donedit();if(a=="roteteright"){var b=userimg.angle+1;zoomingtimer&&setTimeout('newrotate("roteteright")',20)}else{var b=userimg.angle-1;zoomingtimer&&setTimeout('newrotate("roteteleft")',20)}b>=360&&(b=360-b),userimg.set({angle:b}),canvas.renderAll()}function ChangeImageSrc(a){$(".bestillknapp img").attr("data-original-title","Gå til bestilling"),$(".bestillknapp img").tooltip("disable"),canvas.remove(userimg);var b=$(this).attr("src"),c="/images/stream/image/"+a+"/400/400";fabric.Image.fromURL(c,function(b){userimg=b.set({left:220,top:220,lockUniScaling:!0,id:a}),canvas.add(b),userimg.sendToBack()})}function ChangeMalsSrc(a){if(selectiongthumb==1)return!1;selectiongthumb=!0,$(".temp").hide(),$(".templatebuttoncontainer").append('<img class="spinner" src="//static.repix.no/gfx/admin/img/simpletree/spinner.gif">');var b=a.split("/").reverse()[0];malimage="/stabburetstatic/mal/"+b,canvas.remove(template);var c=$(this).attr("src"),d=malimage;return fabric.Image.fromURL(d,function(a){template=a.set({left:220,top:219,lockUniScaling:!0,id:"mal",selectable:!1}),canvas.add(a),template.bringToFront(),selectiongthumb=!1,$(".temp").show(),$(".spinner").remove()}),!0}function positionBtn(a){$("#deletebutton").show();var b=$("#c").offset();$("#deletebutton").css({top:a.top+b.top-a.currentHeight/2-30+"px",left:a.left+b.left+a.currentWidth/2+15+"px"})}function shareThumb(a){var b=canvas.toDataURL(),c="";a=="facebook"&&(c="https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent("http://kampanje.stabburetleverpostei.no/bestill/ShareFacebook/")),$.post("/api/1.0/stabburet/savethumb",{thumb:b},function(a){setTimeout(function(){upenurl(c+a.data),hideloader()},2e3)},"json")}function quickHideAddressBar(){setTimeout(function(){if(window.pageYOffset!==0)return;window.scrollTo(0,window.pageYOffset+1)},1e3)}function showloader(){return $("body").prepend('<div id="loader-overlay"><div class="loadingInfo"><img src="http://a.static.repix.no/gfx/gui/ajax-loader-gray.gif" />                                <br/><br/><h3>Loading.......<span id="status"></span></h3></div></div>'),$("#loader-overlay").css("opacity","0.8").css("margin","0").width($(window).width()).height($(document).height()),!1}function hideloader(){$("#loader-overlay").fadeOut("slow",function(){$(this).remove()})}function downloadURL(a){$idown?$idown.attr("src",a):$idown=$("<iframe/>",{id:"idown",src:a}).hide().appendTo("body"),hideloader()}function upenurl(a){window.location.href=a;return false;return window.open(a,"Stabburet","width=600,height=400,scrollbars=yes"),!1}function isCanvasSupported(){var a=document.createElement("canvas");return!!a.getContext&&!!a.getContext("2d")}fabric.Object.prototype.originX=fabric.Object.prototype.originY="center";var canvas=null,userimg,template,rotateval,zoomval,malimage="/stabburetstatic/mal/Astronaut_alpha.png",blankimage="/stabburetstatic/mal/dittbilde.jpg",malarray=["ASTRONAUT","FOTBALLSPILLER","BALLERINA","BRANNKONSTABEL","ROCKESTJERNE","KLASSISK LOKK"],scale=.05,menuindex=0,userimg=null,zoomingtimer=!1,$idown,selectiongthumb=!1;isCanvasSupported()?$(setup):$(".error").html('Editoren støttes dessverre ikke av din nettleser, vi anbefaler google chrome.<br/>\t\t\tLast ned her <a href="http://www.google.com/intl/no/chrome/browser/">http://www.google.com/intl/no/chrome/browser/</a>').show(),$(function(){$(".zoom").bind("touchstart",function(){return zoomingtimer=!0,newzoom($(this).attr("id")),!1}).mousedown(function(){return zoomingtimer=!0,newzoom($(this).attr("id")),!1}).bind("touchend",stopzoom).mouseup(stopzoom).mouseleave(stopzoom),$(".move").bind("touchstart",function(){return zoomingtimer=!0,movenew($(this).attr("id")),!1}).mousedown(function(){return zoomingtimer=!0,movenew($(this).attr("id")),!1}).bind("touchend",stopzoom).mouseup(stopzoom).mouseleave(stopzoom),$(".rotate").bind("touchstart",function(){return zoomingtimer=!0,newrotate($(this).attr("id")),!1}).mousedown(function(){return zoomingtimer=!0,newrotate($(this).attr("id")),!1}).bind("touchend",stopzoom).mouseup(stopzoom).mouseleave(stopzoom),$("#nexttemplate").on("click",function(){menuindex<5?menuindex++:menuindex=0;var a=$("#template-"+menuindex).attr("src");ChangeMalsSrc(a),$(".choosetemplate, .choosetemplatenew").animate({left:"-=160px",opacity:0},"fast",function(){$(this).remove()}),$(".choosetemplatecontainer").append('<span class="choosetemplatenew" style="left: 160px;opacity: 0">'+malarray[menuindex]+"</span>"),$(".choosetemplatenew").animate({left:"0px",opacity:"1"},"fast"),$(".choosetemplatenew").addClass("choosetemplate").removeClass("choosetemplatenew"),$(".selectedtemplate").removeClass("selectedtemplate"),$("#template-"+menuindex).addClass("selectedtemplate")}),$("#prevtemplate").on("click",function(){menuindex>0?menuindex--:menuindex=5;var a=$("#template-"+menuindex).attr("src");ChangeMalsSrc(a),$(".choosetemplatenew").addClass("choosetemplate"),$(".choosetemplate").animate({left:"+=160px",opacity:0},"fast",function(){$(this).remove()}),$(".choosetemplatecontainer").append('<span class="choosetemplatenew" style="left: -160px; opacity: 0;">'+malarray[menuindex]+"</span>"),$(".choosetemplatenew").animate({left:"0px",opacity:"1"},"fast"),$(".selectedtemplate").removeClass("selectedtemplate"),$("#template-"+menuindex).addClass("selectedtemplate");var a=$("#template-"+menuindex).attr("src");ChangeMalsSrc(a)}),$(window).load(function(){hideloader()}),$(".bestillknapp img").tooltip({position:{my:"center bottom-10",at:"center top"}}),$("#facebook").on("click",function(){return showloader(),shareThumb("facebook"),!1}),$("#twitter").on("click",function(){return showloader(),shareThumb("twitter"),!1}),$(document).on("mousedown",".button, .temp",function(){$(this).css("background-image","url(//static.repix.no/css/portals/stabburet/web/images/controlsdown.jpg)")}),$(document).on("mouseup",".button, .temp",function(){$(this).css("background-image","")}),$(".thumbcontainer img").click(function(){if(selectiongthumb==1)return!1;var a=$(this).attr("src");ChangeMalsSrc(a);var b=$(this).attr("id");return menuindex=b.split("-").reverse()[0],$(".choosetemplate").text(malarray[menuindex]),$(".selectedtemplate").removeClass("selectedtemplate"),$(this).addClass("selectedtemplate"),!1});var a=$(".bar"),b=$(".percent"),c=$("#status"),d="";$("form").ajaxForm({dataType:"json",beforeSend:function(){c.empty();var d="0%";a.width(d),b.html(d)},uploadProgress:function(c,d,e,f){var g=f+"%";a.width(g),b.html(g)},success:function(){var c="100%";a.width(c),b.html(c)},complete:function(a){if(a.responseJSON)d='<img class="imagethumb" id="'+a.responseJSON.image.id+'"src="'+a.responseJSON.image.thumbnail+'" style="height: 75px"  />',$("#imagelist").append(d),ChangeImageSrc(a.responseJSON.image.id),$("img#"+a.responseJSON.name).css("border-color","#0199d8");else{var b=JSON.parse(a.responseText);d='<img class="imagethumb" id="'+b.id+'"src="/images/stream/thumbnail/'+b.thumbnail+'" style="height: 75px"  />',$("#imagelist").append(d),ChangeImageSrc(b.id),$("img#"+b.id).css("border-color","#0199d8")}}})}),$(window).on("load",function(){setTimeout(function(){canvas.renderAll()},150)}),this.save=function(a,b){if(userimg.id=="preimage")return!1;showloader(),userimg.set({opacity:1}),userimg.sendToBack(),userimg.active=!1;var c=canvas.getObjects(),d=c[0]._element,e=c[0].width*c[0].scaleX,f=c[0].height*c[0].scaleY,g=JSON.stringify("["+c[0].left+","+c[0].top+","+e+","+f+","+c[0].angle+"]"),h=$("#c").height(),i=canvas.toDataURLWithMultiplier("jpeg",.8,90),j="small",k=c[0].id;return b=malimage.split("/").reverse()[0],$.post("/api/1.0/stabburet/save",{name:b,year:"",imageid:k,imgpos:g,thumb:i,malsize:h,lokksize:j},function(a){window.location.href="/lag-lokk/checkout/"},"json"),!1},function(a){a.event.special.doubletap={bindType:"touchend",delegateType:"touchend",handle:function(a){var b=a.handleObj,c=jQuery.data(a.target),d=(new Date).getTime(),e=c.lastTouch?d-c.lastTouch:0,f=f==null?300:f;e<f&&e>30?(c.lastTouch=null,a.type=b.origType,["clientX","clientY","pageX","pageY"].forEach(function(b){a[b]=a.originalEvent.changedTouches[0][b]}),b.handler.apply(this,arguments)):c.lastTouch=d}}}(jQuery)
